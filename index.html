<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nous</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3Etext%7Bfont-family:Satoshi,sans-serif;font-weight:300;font-size:72px;fill:%235d6b86%7D%3C/style%3E%3Ccircle cx='50' cy='50' r='35' fill='none' stroke='%23000000' stroke-width='3'/%3E%3Ctext x='50' y='72' text-anchor='middle' letter-spacing='1.5'%3En%3C/text%3E%3C/svg%3E">

    <!-- Satoshi font -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                        'title': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                        'body': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        'calm': {
                            50: '#f8f9fb',
                            100: '#f1f3f7',
                            200: '#e4e8ee',
                            300: '#d1d7e3',
                            400: '#a8b3c7',
                            500: '#7d8ca8',
                            600: '#5d6b86',
                            700: '#4a5568',
                            800: '#363f51',
                            900: '#252d3d',
                        },
                        'accent': {
                            blue: '#6B8DD6',
                            purple: '#8B7FB8',
                            teal: '#5FA8A3',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Set default body font */
        body {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 400;
            background-color: #f8f9fb;
        }

        /* Title styling with letter spacing */
        .nous-title {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 300;
            letter-spacing: 0.025em; /* 2.5% letter spacing */
        }

        /* Regular weight for all headers */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 400;
        }

        /* Soft shadows */
        .soft-shadow {
            box-shadow: 0 2px 12px rgba(99, 110, 129, 0.08), 0 1px 4px rgba(99, 110, 129, 0.04);
        }

        .soft-shadow-lg {
            box-shadow: 0 8px 24px rgba(99, 110, 129, 0.12), 0 2px 8px rgba(99, 110, 129, 0.06);
        }

        /* Pulse animation for success */
        @keyframes neuron-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .neuron-pulse {
            animation: neuron-pulse 1.5s ease-in-out;
        }

        /* Glow effect for streaks */
        @keyframes soft-glow {
            0%, 100% {
                box-shadow: 0 0 8px rgba(107, 141, 214, 0.3), 0 0 16px rgba(107, 141, 214, 0.1);
            }
            50% {
                box-shadow: 0 0 12px rgba(107, 141, 214, 0.5), 0 0 24px rgba(107, 141, 214, 0.2);
            }
        }

        .soft-glow {
            animation: soft-glow 2s ease-in-out infinite;
        }

        /* Circular logo animation */
        @keyframes circle-flow {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -200;
            }
        }

        .circle-flow {
            stroke-dasharray: 100;
            animation: circle-flow 8s linear infinite;
        }
        .timer-display {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 3rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            color: #1f2937;
            text-align: center;
            user-select: none;
            margin: 20px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .timer-display.running {
            color: #10b981;
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .timer-display.paused {
            color: #f59e0b;
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .timer-display .milliseconds {
            font-size: 1.8rem;
            color: #6b7280;
            margin-left: 8px;
        }
        
        .timer-display.running .milliseconds {
            color: #059669;
        }
        
        .timer-display.paused .milliseconds {
            color: #d97706;
        }
    </style>
    <!-- Firebase Configuration - Must load first -->
    <script src="config.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInWithPopup,
            GoogleAuthProvider
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            getDoc,
            onSnapshot,
            query,
            where,
            setDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            getDocs,
            writeBatch,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Make Firebase functions globally available
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInWithPopup = signInWithPopup;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;
        window.serverTimestamp = serverTimestamp;

        // Signal that Firebase SDK is ready
        window.firebaseSDKReady = true;
        window.dispatchEvent(new Event('firebaseReady'));

        // Firebase configuration is loaded from config.js
        // If config.js is not found, the app will show an error
    </script>
<style>
        .timer-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .timer-circle-bg {
            fill: none;
            stroke: #e6e6e6;
            stroke-width: 12;
        }
        .timer-circle-progress {
            fill: none;
            stroke: #007bff;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 1.5rem;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Configuration Validation ---
        // Check if Firebase config is loaded properly
        if (typeof window.__firebase_config === 'undefined' || !window.__firebase_config || !window.__firebase_config.apiKey) {
            console.error("Firebase configuration is missing. The config.js file may not have been generated properly.");
        }

        // --- Helper Functions & Icons ---

        // Icon components (using inline SVG for single-file simplicity)
        const PlayIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polygon', { points: "5 3 19 12 5 21 5 3" }));

        const PauseIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "6", y: "4", width: "4", height: "16" }), React.createElement('rect', { x: "14", y: "4", width: "4", height: "16" }));

        const StopIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }));

        const PlusCircleIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('line', { x1: "12", y1: "8", x2: "12", y2: "16" }), React.createElement('line', { x1: "8", y1: "12", x2: "16", y2: "12" }));

        const TrashIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polyline', { points: "3 6 5 6 21 6" }), React.createElement('path', { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement('line', { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement('line', { x1: "14", y1: "11", x2: "14", y2: "17" }));

        const ChartIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M3 3v18h18" }), React.createElement('path', { d: "M18.7 8a6 6 0 0 0-6 0" }), React.createElement('path', { d: "M12.7 14a6 6 0 0 0-6 0" }), React.createElement('path', { d: "m20.7 17.5-8-8" }));

        const HomeIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" }), React.createElement('polyline', { points: "9 22 9 12 15 12 15 22" }));

        const LogOutIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement('polyline', { points: "16 17 21 12 16 7" }), React.createElement('line', { x1: "21", y1: "12", x2: "9", y2: "12" }));

        const LoaderIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: "animate-spin"
        }, React.createElement('line', { x1: "12", y1: "2", x2: "12", y2: "6" }), React.createElement('line', { x1: "12", y1: "18", x2: "12", y2: "22" }), React.createElement('line', { x1: "4.93", y1: "4.93", x2: "7.76", y2: "7.76" }), React.createElement('line', { x1: "16.24", y1: "16.24", x2: "19.07", y2: "19.07" }), React.createElement('line', { x1: "2", y1: "12", x2: "6", y2: "12" }), React.createElement('line', { x1: "18", y1: "12", x2: "22", y2: "12" }), React.createElement('line', { x1: "4.93", y1: "19.07", x2: "7.76", y2: "16.24" }), React.createElement('line', { x1: "16.24", y1: "7.76", x2: "19.07", y2: "4.93" }));

        const GoogleIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 48 48"
        },
            React.createElement('path', { fill: "#FFC107", d: "M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" }),
            React.createElement('path', { fill: "#FF3D00", d: "M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" }),
            React.createElement('path', { fill: "#4CAF50", d: "M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" }),
            React.createElement('path', { fill: "#1976D2", d: "M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" })
        );

        const SettingsIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "3" }), React.createElement('path', { d: "M12 1v6m0 6v6m-6-6h6m6 0h6" }));

        const NotebookIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20" }), React.createElement('path', { d: "M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" }));

        const UsersIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" }), React.createElement('circle', { cx: "9", cy: "7", r: "4" }), React.createElement('path', { d: "M23 21v-2a4 4 0 0 0-3-3.87" }), React.createElement('path', { d: "M16 3.13a4 4 0 0 1 0 7.75" }));

        const TrophyIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M6 9H4.5a2.5 2.5 0 0 1 0-5H6" }), React.createElement('path', { d: "M18 9h1.5a2.5 2.5 0 0 0 0-5H18" }), React.createElement('path', { d: "M4 22h16" }), React.createElement('path', { d: "M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" }), React.createElement('path', { d: "M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" }), React.createElement('path', { d: "M18 2H6v7a6 6 0 0 0 12 0V2Z" }));

        const SearchIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "11", cy: "11", r: "8" }), React.createElement('path', { d: "m21 21-4.35-4.35" }));

        const CheckIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polyline', { points: "20 6 9 17 4 12" }));

        const XIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('line', { x1: "18", y1: "6", x2: "6", y2: "18" }), React.createElement('line', { x1: "6", y1: "6", x2: "18", y2: "18" }));

        const InfoIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('line', { x1: "12", y1: "16", x2: "12", y2: "12" }), React.createElement('line', { x1: "12", y1: "8", x2: "12.01", y2: "8" }));

        const PencilIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" }));

        const ArrowUpIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('line', { x1: "12", y1: "19", x2: "12", y2: "5" }), React.createElement('polyline', { points: "5 12 12 5 19 12" }));

        const ArrowDownIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('line', { x1: "12", y1: "5", x2: "12", y2: "19" }), React.createElement('polyline', { points: "19 12 12 19 5 12" }));

        const GripIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        },
            React.createElement('circle', { cx: "9", cy: "5", r: "1" }),
            React.createElement('circle', { cx: "9", cy: "12", r: "1" }),
            React.createElement('circle', { cx: "9", cy: "19", r: "1" }),
            React.createElement('circle', { cx: "15", cy: "5", r: "1" }),
            React.createElement('circle', { cx: "15", cy: "12", r: "1" }),
            React.createElement('circle', { cx: "15", cy: "19", r: "1" })
        );

        // Logo component with circular flow around 'n'
        const NousLogo = ({ size = "medium" }) => {
            const sizes = {
                small: { width: 70, fontSize: "1.5rem" },
                medium: { width: 100, fontSize: "2.25rem" },
                large: { width: 140, fontSize: "3rem" }
            };
            const { width, fontSize } = sizes[size];

            return React.createElement('div', {
                className: "flex items-center gap-2",
                style: { position: 'relative' }
            },
                // SVG circular flow
                React.createElement('svg', {
                    width: width,
                    height: width * 0.5,
                    viewBox: "0 0 100 50",
                    style: { position: 'absolute', left: -8, top: '50%', transform: 'translateY(-50%)', zIndex: 0, opacity: 0.6 }
                },
                    React.createElement('circle', {
                        cx: "20",
                        cy: "25",
                        r: "18",
                        fill: "none",
                        stroke: "#6B8DD6",
                        strokeWidth: "1.5",
                        className: "circle-flow",
                        opacity: "0.4"
                    })
                ),
                // Text
                React.createElement('span', {
                    className: "nous-title",
                    style: {
                        fontSize,
                        color: '#5d6b86',
                        position: 'relative',
                        zIndex: 1
                    }
                }, "nous")
            );
        };

        // Function to format time like Google Timer with milliseconds
        const formatTime = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((totalMilliseconds % 1000) / 10);
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        };

        // Function to format time for display (without milliseconds)
        const formatTimeDisplay = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        // Function to get milliseconds for display
        const getMilliseconds = (totalMilliseconds) => {
            return Math.floor((totalMilliseconds % 1000) / 10);
        };

        // Function to format Firestore Timestamp to a readable date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        };

        // Generate unique friend code
        const generateFriendCode = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        };

        // Generate unique friend code with collision check
        const generateUniqueFriendCode = async (db) => {
            let attempts = 0;
            const maxAttempts = 10;

            while (attempts < maxAttempts) {
                const code = generateFriendCode();

                // Check if this code already exists
                try {
                    const usersQuery = window.query(
                        window.collection(db, 'users'),
                        window.where('friendCode', '==', code)
                    );
                    const snapshot = await window.getDocs(usersQuery);

                    if (snapshot.empty) {
                        // Code is unique!
                        return code;
                    }
                    attempts++;
                } catch (error) {
                    console.error("Error checking friend code uniqueness:", error);
                    // If query fails, just return the code
                    return code;
                }
            }

            // If we somehow can't find a unique code after 10 attempts,
            // add a timestamp to make it unique
            return generateFriendCode() + Date.now().toString(36).slice(-2);
        };

        // Tree types with unlock requirements (total hours studied)
        const TREE_TYPES = [
            { id: 'seedling', name: 'Seedling', requiredHours: 0, color: '#86efac' },
            { id: 'oak', name: 'Oak Tree', requiredHours: 10, color: '#34d399' },
            { id: 'cherry', name: 'Cherry Blossom', requiredHours: 25, color: '#fda4af' },
            { id: 'pine', name: 'Pine Tree', requiredHours: 50, color: '#10b981' },
            { id: 'willow', name: 'Willow Tree', requiredHours: 100, color: '#6ee7b7' },
            { id: 'sakura', name: 'Ancient Sakura', requiredHours: 200, color: '#f472b6' }
        ];

        // Calculate total study hours from sessions
        const calculateTotalHours = (sessions) => {
            const totalMs = sessions.reduce((sum, s) => sum + (s.duration || 0), 0);
            return totalMs / (1000 * 60 * 60); // Convert to hours
        };

        // Get tree growth stage based on hours (0-100%)
        const getTreeGrowth = (totalHours) => {
            return Math.min(100, (totalHours / 5) * 100); // Full growth at 5 hours
        };

        // Get available tree types based on hours
        const getUnlockedTrees = (totalHours) => {
            return TREE_TYPES.filter(tree => totalHours >= tree.requiredHours);
        };

        // --- Authentication Component ---
        const AuthComponent = ({ auth, setNotification }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                try {
                    if (isSignUp) {
                        await window.createUserWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Signed up successfully! You are now logged in.' });
                    } else {
                        await window.signInWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Logged in successfully!' });
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    setNotification({ type: 'error', message: error.message });
                }
            };
            
            const handleAnonymousSignIn = async () => {
                try {
                    await window.signInAnonymously(auth);
                    setNotification({ type: 'success', message: 'Signed in as a guest. Your data is temporary.' });
                } catch (error) {
                    console.error("Anonymous sign-in error:", error);
                    setNotification({ type: 'error', message: "Could not sign in as a guest." });
                }
            };

            const handleGoogleSignIn = async () => {
                try {
                    const provider = new window.GoogleAuthProvider();
                    await window.signInWithPopup(auth, provider);
                    setNotification({ type: 'success', message: 'Signed in with Google successfully!' });
                } catch (error) {
                    console.error("Google sign-in error:", error);
                    setNotification({ type: 'error', message: error.message });
                }
            };

            return React.createElement('div', { className: "min-h-screen flex flex-col justify-center items-center p-4", style: { backgroundColor: '#f8f9fb' } },
                React.createElement('div', { className: "max-w-md w-full bg-white soft-shadow-lg p-8 space-y-6", style: { borderRadius: '20px' } },
                    React.createElement('div', { className: "flex flex-col items-center" },
                        React.createElement(NousLogo, { size: "large" }),
                        React.createElement('p', { className: "text-calm-600 mt-4", style: { fontWeight: 300 } }, "log in or sign up to track your progress")
                    ),
                    React.createElement('form', { onSubmit: handleAuthAction, className: "space-y-4" },
                        React.createElement('input', {
                            type: "email",
                            value: email,
                            onChange: (e) => setEmail(e.target.value),
                            placeholder: "Email address",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('input', {
                            type: "password",
                            value: password,
                            onChange: (e) => setPassword(e.target.value),
                            placeholder: "Password (6+ characters)",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('button', {
                            type: "submit",
                            className: "w-full text-white py-3 px-4 rounded-xl soft-shadow hover:opacity-90 focus:outline-none transition",
                            style: { backgroundColor: '#6B8DD6', fontWeight: 400 }
                        }, isSignUp ? 'sign up' : 'log in')
                    ),
                    React.createElement('div', { className: "text-center" },
                        React.createElement('button', { onClick: () => setIsSignUp(!isSignUp), className: "text-sm text-blue-600 hover:underline" },
                            isSignUp ? 'Already have an account? Log In' : "Don't have an account? Sign Up"
                        )
                    ),
                    React.createElement('div', { className: "relative flex py-3 items-center" },
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" }),
                        React.createElement('span', { className: "flex-shrink mx-4 text-gray-400" }, "Or"),
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" })
                    ),
                    React.createElement('button', {
                        onClick: handleGoogleSignIn,
                        className: "w-full bg-white soft-shadow text-calm-700 py-3 px-4 rounded-xl hover:bg-calm-50 focus:outline-none transition flex items-center justify-center gap-3",
                        style: { fontWeight: 400 }
                    },
                        React.createElement(GoogleIcon),
                        "continue with Google"
                    ),
                    React.createElement('button', {
                        onClick: handleAnonymousSignIn,
                        className: "w-full bg-calm-100 text-calm-700 py-3 px-4 rounded-xl hover:bg-calm-200 focus:outline-none transition",
                        style: { fontWeight: 400 }
                    }, "continue as guest")
                )
            );
        };

        // --- Main App Components ---

        const Header = ({ setCurrentPage, currentPage }) => {
            return React.createElement('header', { className: "bg-white sticky top-0 z-10 soft-shadow" },
                React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
                    React.createElement('div', { className: "flex justify-between items-center h-16" },
                        React.createElement(NousLogo, { size: "medium" }),
                        React.createElement('nav', { className: "flex items-center space-x-2" },
                            React.createElement('button', {
                                onClick: () => setCurrentPage('dashboard'),
                                title: "Dashboard",
                                className: `p-2 rounded-full transition ${currentPage === 'dashboard' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'dashboard' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(HomeIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('about'),
                                title: "About Nous",
                                className: `p-2 rounded-full transition ${currentPage === 'about' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'about' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(InfoIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('goals'),
                                title: "Goals",
                                className: `p-2 rounded-full transition ${currentPage === 'goals' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'goals' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(NotebookIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('friends'),
                                title: "Friends",
                                className: `p-2 rounded-full transition ${currentPage === 'friends' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'friends' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(UsersIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('leaderboard'),
                                title: "Leaderboard",
                                className: `p-2 rounded-full transition ${currentPage === 'leaderboard' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'leaderboard' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(TrophyIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('reports'),
                                title: "Monthly Reports",
                                className: `p-2 rounded-full transition ${currentPage === 'reports' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'reports' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(ChartIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('settings'),
                                title: "Settings",
                                className: `p-2 rounded-full transition ${currentPage === 'settings' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'settings' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(SettingsIcon)
                            )
                        )
                    )
                )
            );
        };

        const ManualEntryModal = ({ db, userId, habit, onClose, setNotification }) => {
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [hours, setHours] = useState('');
            const [minutes, setMinutes] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                const totalMinutes = parseInt(hours || 0) * 60 + parseInt(minutes || 0);
                if (totalMinutes <= 0) {
                    setNotification({ type: 'error', message: 'Duration must be greater than zero.' });
                    return;
                }

                try {
                    const sessionDate = new Date(date);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                    await window.addDoc(sessionsCol, {
                        habitId: habit.id,
                        habitName: habit.name,
                        startTime: window.Timestamp.fromDate(sessionDate),
                        endTime: window.Timestamp.fromDate(new Date(sessionDate.getTime() + totalMinutes * 60000)),
                        duration: totalMinutes * 60 * 1000, // store in milliseconds
                    });
                    setNotification({ type: 'success', message: 'Manual session added successfully.' });
                    onClose();
                } catch (error) {
                    console.error("Error adding manual session:", error);
                    setNotification({ type: 'error', message: 'Failed to add manual session.' });
                }
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-20" },
                React.createElement('div', { className: "bg-white rounded-lg p-8 w-full max-w-md m-4" },
                    React.createElement('h2', { className: "text-2xl mb-4", style: { fontWeight: 400 } }, `add manual entry for "${habit.name}"`),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: "date", className: "block text-sm text-gray-700", style: { fontWeight: 400 } }, "date"),
                            React.createElement('input', {
                                type: "date",
                                id: "date",
                                value: date,
                                onChange: e => setDate(e.target.value),
                                className: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm text-gray-700", style: { fontWeight: 400 } }, "duration"),
                            React.createElement('div', { className: "flex items-center space-x-2 mt-1" },
                                React.createElement('input', {
                                    type: "number",
                                    value: hours,
                                    onChange: e => setHours(e.target.value),
                                    placeholder: "Hours",
                                    min: "0",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                }),
                                React.createElement('input', {
                                    type: "number",
                                    value: minutes,
                                    onChange: e => setMinutes(e.target.value),
                                    placeholder: "Minutes",
                                    min: "0",
                                    max: "59",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-end space-x-2 pt-4" },
                            React.createElement('button', { type: "button", onClick: onClose, className: "px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300", style: { fontWeight: 400 } }, "cancel"),
                            React.createElement('button', { type: "submit", className: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700", style: { fontWeight: 400 } }, "save")
                        )
                    )
                )
            );
        };

        // Update user stats in /users collection
        const updateUserStats = async (db, userId, sessions) => {
            try {
                const userDocRef = window.doc(db, 'users', userId);

                const totalHours = calculateTotalHours(sessions);
                const totalSessions = sessions.length;

                // Calculate current streak
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let streak = 0;
                let checkDate = new Date(today);

                const sortedSessions = [...sessions].sort((a, b) =>
                    b.startTime.toMillis() - a.startTime.toMillis()
                );

                for (let i = 0; i < 365; i++) {
                    const dayStart = new Date(checkDate);
                    const dayEnd = new Date(checkDate);
                    dayEnd.setHours(23, 59, 59, 999);

                    const hasSessionOnDay = sortedSessions.some(s => {
                        const sessionDate = s.startTime.toDate();
                        return sessionDate >= dayStart && sessionDate <= dayEnd;
                    });

                    if (hasSessionOnDay) {
                        streak++;
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else if (i === 0 && checkDate.getTime() === today.getTime()) {
                        checkDate.setDate(checkDate.getDate() - 1);
                    } else {
                        break;
                    }
                }

                // Calculate hours studied today
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date();
                todayEnd.setHours(23, 59, 59, 999);

                const todaySessions = sessions.filter(s => {
                    const sessionDate = s.startTime.toDate();
                    return sessionDate >= todayStart && sessionDate <= todayEnd;
                });

                const hoursToday = todaySessions.reduce((total, session) => {
                    return total + (session.duration || 0);
                }, 0) / (1000 * 60 * 60);

                // Calculate longest session
                const longestSession = sessions.reduce((max, session) => {
                    const duration = session.duration || 0;
                    return duration > max ? duration : max;
                }, 0) / (1000 * 60 * 60);

                await window.setDoc(userDocRef, {
                    stats: {
                        totalHours,
                        currentStreak: streak,
                        totalSessions,
                        hoursToday,
                        longestSession,
                        goalsCompleted: 0,
                        treeLevel: Math.floor(totalHours / 10),
                        lastUpdated: window.Timestamp.now()
                    }
                }, { merge: true });
            } catch (error) {
                console.error("Error updating user stats:", error);
            }
        };

        const Dashboard = ({ db, userId, setNotification, activeTimers, setActiveTimers, timerIntervals }) => {
            const [habits, setHabits] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [newHabitName, setNewHabitName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [modalHabit, setModalHabit] = useState(null);
            const [editingHabitId, setEditingHabitId] = useState(null);
            const [tempHabitName, setTempHabitName] = useState('');
            const [draggedHabitId, setDraggedHabitId] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);

                const unsubscribeHabits = window.onSnapshot(habitsCol, async (snapshot) => {
                    const habitsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // If this is a new user with no habits, create default habits
                    if (habitsData.length === 0) {
                        const defaultHabits = ['Study', 'Exercise'];
                        try {
                            for (let i = 0; i < defaultHabits.length; i++) {
                                await window.addDoc(habitsCol, {
                                    name: defaultHabits[i],
                                    createdAt: window.Timestamp.now(),
                                    isDefault: true,
                                    order: i
                                });
                            }
                            setNotification({ type: 'success', message: 'Welcome! Default habits created for you.' });
                        } catch (error) {
                            console.error("Error creating default habits:", error);
                            setNotification({ type: 'error', message: 'Failed to create default habits.' });
                        }
                    }

                    // Initialize order field for existing habits that don't have it
                    const habitsNeedingOrder = habitsData.filter(h => h.order === undefined);
                    if (habitsNeedingOrder.length > 0) {
                        try {
                            const batch = window.writeBatch(db);
                            habitsNeedingOrder.forEach((habit, index) => {
                                const habitRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habit.id}`);
                                batch.update(habitRef, { order: index });
                            });
                            await batch.commit();
                        } catch (error) {
                            console.error("Error initializing habit order:", error);
                        }
                    }

                    // Sort habits by order field
                    habitsData.sort((a, b) => (a.order || 0) - (b.order || 0));
                    setHabits(habitsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching habits:", error);
                    setNotification({ type: 'error', message: "Could not fetch habits." });
                    setIsLoading(false);
                });

                const unsubscribeSessions = window.onSnapshot(sessionsCol, (snapshot) => {
                    const sessionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort sessions by start time, descending
                    sessionsData.sort((a, b) => b.startTime.toMillis() - a.startTime.toMillis());
                    setSessions(sessionsData);

                    // Update user stats whenever sessions change
                    if (sessionsData.length > 0) {
                        updateUserStats(db, userId, sessionsData);
                    }
                }, (error) => {
                    console.error("Error fetching sessions:", error);
                    setNotification({ type: 'error', message: "Could not fetch sessions." });
                });

                return () => {
                    unsubscribeHabits();
                    unsubscribeSessions();
                    // Don't clear intervals - they persist at App level
                };
            }, [db, userId, appId, setNotification]);

            // Listen for active timer changes from Firebase
            useEffect(() => {
                if (!db || !userId) return;

                const activeTimersCol = window.collection(db, `/artifacts/${appId}/users/${userId}/activeTimers`);
                const unsubscribeTimers = window.onSnapshot(activeTimersCol, (snapshot) => {
                    const timersData = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        timersData[doc.id] = {
                            habitId: data.habitId,
                            habitName: data.habitName,
                            startTime: data.startTime,
                            elapsedBeforePause: data.elapsedBeforePause || 0,
                            isPaused: data.isPaused,
                            originalStartTime: data.originalStartTime || data.startTime
                        };
                    });
                    setActiveTimers(timersData);
                }, (error) => {
                    console.error("Error fetching active timers:", error);
                });

                return () => unsubscribeTimers();
            }, [db, userId, appId]);

            // Update timer display every 10ms for running timers
            useEffect(() => {
                const interval = setInterval(() => {
                    setActiveTimers(prev => {
                        const updated = { ...prev };
                        let hasChanges = false;

                        Object.keys(updated).forEach(habitId => {
                            const timer = updated[habitId];
                            if (!timer.isPaused && timer.startTime) {
                                // Force re-render to update display
                                hasChanges = true;
                            }
                        });

                        // Only trigger re-render if there are running timers
                        return hasChanges ? { ...updated } : prev;
                    });
                }, 10);

                return () => clearInterval(interval);
            }, []);

            const handleAddHabit = async (e) => {
                e.preventDefault();
                if (newHabitName.trim() === '') return;
                try {
                    const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                    // New habits go to the end
                    const maxOrder = habits.length > 0 ? Math.max(...habits.map(h => h.order || 0)) : -1;
                    await window.addDoc(habitsCol, {
                        name: newHabitName,
                        createdAt: window.Timestamp.now(),
                        order: maxOrder + 1
                    });
                    setNewHabitName('');
                    setNotification({ type: 'success', message: 'Habit added!' });
                } catch (error) {
                    console.error("Error adding habit:", error);
                    setNotification({ type: 'error', message: 'Failed to add habit.' });
                }
            };

            const handleDeleteHabit = async (habitId) => {
                if (window.confirm("Are you sure you want to delete this habit and all its sessions? This cannot be undone.")) {
                    try {
                        // Use a batch write to delete the habit and all its sessions atomically
                        const batch = window.writeBatch(db);
                        
                        // 1. Delete the habit document
                        const habitDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habitId}`);
                        batch.delete(habitDocRef);
                        
                        // 2. Query and delete all associated sessions
                        const sessionsQuery = window.query(window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`), window.where("habitId", "==", habitId));
                        const sessionsSnapshot = await window.getDocs(sessionsQuery);
                        sessionsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        setNotification({ type: 'success', message: 'Habit and all its sessions deleted.' });
                    } catch (error) {
                        console.error("Error deleting habit:", error);
                        setNotification({ type: 'error', message: 'Failed to delete habit.' });
                    }
                }
            };

            const handleDeleteSession = async (sessionId) => {
                if (window.confirm("Are you sure you want to delete this session? This cannot be undone.")) {
                    try {
                        const sessionDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/sessions/${sessionId}`);
                        await window.deleteDoc(sessionDocRef);
                        setNotification({ type: 'success', message: 'Session deleted successfully.' });
                    } catch (error) {
                        console.error("Error deleting session:", error);
                        setNotification({ type: 'error', message: 'Failed to delete session.' });
                    }
                }
            };

            const handleRenameHabit = async (habitId, newName) => {
                console.log('handleRenameHabit called:', { habitId, newName });

                if (!newName || newName.trim() === '') {
                    console.log('Empty name, rejecting');
                    setNotification({ type: 'error', message: 'Habit name cannot be empty.' });
                    return;
                }

                try {
                    console.log('Updating habit in Firestore...');
                    const habitDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habitId}`);
                    await window.updateDoc(habitDocRef, { name: newName.trim() });
                    console.log('Habit document updated');

                    // Also update all sessions with this habit
                    console.log('Updating sessions...');
                    const sessionsQuery = window.query(
                        window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`),
                        window.where("habitId", "==", habitId)
                    );
                    const sessionsSnapshot = await window.getDocs(sessionsQuery);
                    console.log(`Found ${sessionsSnapshot.size} sessions to update`);

                    const batch = window.writeBatch(db);
                    sessionsSnapshot.forEach(doc => {
                        batch.update(doc.ref, { habitName: newName.trim() });
                    });
                    await batch.commit();
                    console.log('Sessions updated');

                    setEditingHabitId(null);
                    setTempHabitName('');
                    setNotification({ type: 'success', message: 'Habit renamed!' });
                    console.log('Rename complete!');
                } catch (error) {
                    console.error("Error renaming habit:", error);
                    setNotification({ type: 'error', message: 'Failed to rename habit.' });
                }
            };

            const handleDragStart = (e, habitId) => {
                setDraggedHabitId(habitId);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.currentTarget);
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverIndex(index);
            };

            const handleDragLeave = () => {
                setDragOverIndex(null);
            };

            const handleDrop = async (e, targetIndex) => {
                e.preventDefault();
                setDragOverIndex(null);

                if (!draggedHabitId) return;

                const draggedIndex = habits.findIndex(h => h.id === draggedHabitId);
                if (draggedIndex === -1 || draggedIndex === targetIndex) {
                    setDraggedHabitId(null);
                    return;
                }

                try {
                    // Reorder the habits array
                    const reorderedHabits = [...habits];
                    const [draggedItem] = reorderedHabits.splice(draggedIndex, 1);
                    reorderedHabits.splice(targetIndex, 0, draggedItem);

                    // Update order field for all habits in batch
                    const batch = window.writeBatch(db);
                    reorderedHabits.forEach((habit, index) => {
                        const habitRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habit.id}`);
                        batch.update(habitRef, { order: index });
                    });

                    await batch.commit();
                } catch (error) {
                    console.error("Error reordering habit:", error);
                    setNotification({ type: 'error', message: 'Failed to reorder habit.' });
                }

                setDraggedHabitId(null);
            };

            const handleDragEnd = () => {
                setDraggedHabitId(null);
                setDragOverIndex(null);
            };

            // Helper function to calculate current elapsed time for a timer
            const getTimerElapsedTime = useCallback((timer) => {
                if (!timer) return 0;
                if (timer.isPaused) {
                    return timer.elapsedBeforePause || 0;
                }
                // Timer is running - calculate elapsed time from start
                const elapsedBeforePause = timer.elapsedBeforePause || 0;
                const sessionElapsed = timer.startTime ? Date.now() - timer.startTime.toMillis() : 0;
                return elapsedBeforePause + sessionElapsed;
            }, []);

            const startTimer = useCallback(async (habitId) => {
                const habit = habits.find(h => h.id === habitId);
                if (!habit) return;

                try {
                    const timerDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/activeTimers/${habitId}`);
                    const existingTimer = activeTimers[habitId];

                    // Save timer to Firebase with server timestamp
                    await window.setDoc(timerDocRef, {
                        habitId,
                        habitName: habit.name,
                        startTime: window.serverTimestamp(),
                        elapsedBeforePause: existingTimer?.elapsedBeforePause || 0,
                        isPaused: false,
                        // Keep track of original start time for session recording
                        originalStartTime: existingTimer?.originalStartTime || window.serverTimestamp()
                    });

                    // Update currentTopic in user profile
                    const userDocRef = window.doc(db, 'users', userId);
                    await window.setDoc(userDocRef, {
                        currentTopic: habit.name
                    }, { merge: true });
                } catch (error) {
                    console.error("Error starting timer:", error);
                    setNotification({ type: 'error', message: 'Failed to start timer.' });
                }
            }, [db, userId, appId, habits, activeTimers, setNotification]);

            const pauseTimer = useCallback(async (habitId) => {
                const timer = activeTimers[habitId];
                if (!timer) return;

                try {
                    const timerDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/activeTimers/${habitId}`);

                    // Calculate total elapsed time including current session
                    const currentElapsed = timer.elapsedBeforePause || 0;
                    const sessionElapsed = timer.startTime ? Date.now() - timer.startTime.toMillis() : 0;
                    const totalElapsed = currentElapsed + sessionElapsed;

                    await window.updateDoc(timerDocRef, {
                        isPaused: true,
                        elapsedBeforePause: totalElapsed,
                        lastPauseTime: window.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error pausing timer:", error);
                    setNotification({ type: 'error', message: 'Failed to pause timer.' });
                }
            }, [db, userId, appId, activeTimers, setNotification]);

            const stopTimer = useCallback(async (habitId, habitName) => {
                const timerData = activeTimers[habitId];

                if (timerData) {
                    try {
                        // Calculate total elapsed time
                        const currentElapsed = timerData.elapsedBeforePause || 0;
                        const sessionElapsed = (!timerData.isPaused && timerData.startTime)
                            ? Date.now() - timerData.startTime.toMillis()
                            : 0;
                        const totalElapsed = currentElapsed + sessionElapsed;

                        if (totalElapsed > 0) {
                            // Save session to Firebase
                            const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                            const originalStartTime = timerData.originalStartTime || timerData.startTime;

                            await window.addDoc(sessionsCol, {
                                habitId,
                                habitName,
                                startTime: originalStartTime,
                                endTime: window.Timestamp.now(),
                                duration: Math.round(totalElapsed)
                            });
                            setNotification({ type: 'success', message: `Session for ${habitName} saved.` });
                        }

                        // Delete from activeTimers collection
                        const timerDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/activeTimers/${habitId}`);
                        await window.deleteDoc(timerDocRef);

                        // Clear currentTopic in user profile if no other timers are active
                        const remainingTimers = Object.keys(activeTimers).filter(id => id !== habitId);
                        if (remainingTimers.length === 0) {
                            const userDocRef = window.doc(db, 'users', userId);
                            await window.setDoc(userDocRef, {
                                currentTopic: null
                            }, { merge: true });
                        }
                    } catch(error) {
                        console.error("Error stopping timer:", error);
                        setNotification({ type: 'error', message: 'Failed to stop timer.' });
                    }
                }
            }, [activeTimers, db, userId, appId, setNotification]);

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading your dashboard...")
                );
            }

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8" },
                modalHabit && React.createElement(ManualEntryModal, { db, userId, habit: modalHabit, onClose: () => setModalHabit(null), setNotification }),
                
                // Left/Main Column: Habits
                React.createElement('div', { className: "lg:col-span-2" },
                    React.createElement('h2', { className: "text-2xl text-gray-800 mb-4", style: { fontWeight: 300 } }, "my habits"),

                    // Add new habit form
                    React.createElement('form', { onSubmit: handleAddHabit, className: "bg-white p-4 rounded-lg shadow-sm mb-6 flex gap-4" },
                        React.createElement('input', {
                            type: "text",
                            value: newHabitName,
                            onChange: (e) => setNewHabitName(e.target.value),
                            placeholder: "e.g., Morning Run",
                            className: "flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        }),
                        React.createElement('button', { type: "submit", className: "bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition", style: { fontWeight: 400 } }, "add habit")
                    ),

                    // Habits List
                    React.createElement('div', { className: "space-y-4" },
                        habits.length > 0 ? habits.map((habit, index) => {
                            const timer = activeTimers[habit.id];
                            const isRunning = timer && !timer.isPaused;
                            const isEditing = editingHabitId === habit.id;
                            const isDragging = draggedHabitId === habit.id;
                            const isDropTarget = dragOverIndex === index;

                            return React.createElement('div', {
                                key: habit.id,
                                draggable: !isEditing,
                                onDragStart: (e) => handleDragStart(e, habit.id),
                                onDragOver: (e) => handleDragOver(e, index),
                                onDragLeave: handleDragLeave,
                                onDrop: (e) => handleDrop(e, index),
                                onDragEnd: handleDragEnd,
                                className: `bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row sm:items-center gap-4 transition-all ${isDragging ? 'opacity-50 scale-95' : ''} ${isDropTarget ? 'border-2 border-blue-400 border-dashed' : ''}`
                            },
                                // Drag handle (left side)
                                React.createElement('div', {
                                    className: `p-2 text-gray-400 transition ${isEditing ? 'cursor-default opacity-30' : 'cursor-move hover:text-gray-600'}`,
                                    title: isEditing ? "" : "Drag to reorder",
                                    onMouseDown: (e) => {
                                        if (isEditing) e.preventDefault();
                                    }
                                },
                                    React.createElement(GripIcon)
                                ),

                                // Habit name and timer (middle)
                                React.createElement('div', { className: "flex-grow" },
                                    isEditing ?
                                        React.createElement('div', { className: "flex items-center gap-2 mb-4" },
                                            React.createElement('input', {
                                                type: "text",
                                                value: tempHabitName,
                                                onChange: (e) => setTempHabitName(e.target.value),
                                                onKeyDown: (e) => {
                                                    if (e.key === 'Enter') handleRenameHabit(habit.id, tempHabitName);
                                                    if (e.key === 'Escape') { setEditingHabitId(null); setTempHabitName(''); }
                                                },
                                                className: "flex-grow px-3 py-1 border border-blue-400 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none",
                                                autoFocus: true
                                            }),
                                            React.createElement('button', {
                                                onClick: () => {
                                                    console.log('Save button clicked');
                                                    handleRenameHabit(habit.id, tempHabitName);
                                                },
                                                className: "p-2 bg-green-100 text-green-600 rounded hover:bg-green-200 transition",
                                                title: "Save"
                                            },
                                                React.createElement(CheckIcon)
                                            ),
                                            React.createElement('button', {
                                                onClick: () => { setEditingHabitId(null); setTempHabitName(''); },
                                                className: "p-2 bg-red-100 text-red-600 rounded hover:bg-red-200 transition",
                                                title: "Cancel"
                                            },
                                                React.createElement(XIcon)
                                            )
                                        ) :
                                        React.createElement('div', { className: "flex items-center gap-2 mb-4" },
                                            React.createElement('h3', { className: "text-xl text-gray-700", style: { fontWeight: 400 } }, habit.name),
                                            React.createElement('button', {
                                                onClick: () => { setEditingHabitId(habit.id); setTempHabitName(habit.name); },
                                                className: "p-1 text-gray-400 hover:text-gray-600 transition",
                                                title: "Rename habit"
                                            },
                                                React.createElement(PencilIcon)
                                            )
                                        ),
                                    React.createElement('div', {
                                        className: `timer-display ${isRunning ? 'running' : (timer ? 'paused' : '')}`
                                    },
                                        React.createElement('span', null, formatTimeDisplay(getTimerElapsedTime(timer))),
                                        React.createElement('span', { className: "milliseconds" },
                                            `.${String(getMilliseconds(getTimerElapsedTime(timer))).padStart(2, '0')}`
                                        )
                                    )
                                ),

                                // Action buttons (right side)
                                React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                                    isRunning ?
                                        React.createElement('button', { onClick: () => pauseTimer(habit.id), className: "p-3 bg-yellow-100 text-yellow-600 rounded-full hover:bg-yellow-200 transition" },
                                            React.createElement(PauseIcon)
                                        ) :
                                        React.createElement('button', { onClick: () => startTimer(habit.id), className: "p-3 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition" },
                                            React.createElement(PlayIcon)
                                        ),
                                    React.createElement('button', { onClick: () => stopTimer(habit.id, habit.name), disabled: !timer, className: "p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" },
                                        React.createElement(StopIcon)
                                    ),
                                    React.createElement('button', { onClick: () => setModalHabit(habit), className: "p-3 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition" },
                                        React.createElement(PlusCircleIcon)
                                    ),
                                    React.createElement('button', { onClick: () => handleDeleteHabit(habit.id), className: "p-3 bg-gray-100 text-gray-500 rounded-full hover:bg-gray-200 transition" },
                                        React.createElement(TrashIcon)
                                    )
                                )
                            );
                        }) :
                        React.createElement('p', { className: "text-gray-500 text-center py-8" }, "No habits yet. Add one to get started!")
                    )
                ),

                // Right/Side Column: Growth Tree & Recent Sessions
                React.createElement('div', { className: "lg:col-span-1 space-y-6" },
                    // Growth Tree
                    React.createElement(GrowthTree, { sessions, db, userId, setNotification }),

                    // Recent Sessions
                    React.createElement('div', null,
                        React.createElement('h2', { className: "text-2xl text-gray-800 mb-4", style: { fontWeight: 300 } }, "recent sessions"),
                        React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm space-y-3 max-h-[600px] overflow-y-auto" },
                            sessions.length > 0 ? sessions.slice(0, 15).map(session =>
                                React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0 flex items-center justify-between gap-2" },
                                    React.createElement('div', { className: "flex-grow" },
                                        React.createElement('p', { style: { fontWeight: 400 } }, session.habitName),
                                        React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                            React.createElement('span', null, formatDate(session.startTime)),
                                            React.createElement('span', null, formatTime(session.duration))
                                        )
                                    ),
                                    React.createElement('button', {
                                        onClick: () => handleDeleteSession(session.id),
                                        className: "p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition flex-shrink-0",
                                        title: "Delete session"
                                    },
                                        React.createElement(TrashIcon)
                                    )
                                )
                            ) :
                            React.createElement('p', { className: "text-gray-500" }, "No sessions recorded yet.")
                        )
                    )
                )
            );
        };

        const Reports = ({ db, userId, setNotification }) => {
            const [reportData, setReportData] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;

                const fetchReportData = async () => {
                    setIsLoading(true);
                    try {
                        const [year, monthNum] = month.split('-').map(Number);
                        const startDate = new Date(year, monthNum - 1, 1);
                        const endDate = new Date(year, monthNum, 0, 23, 59, 59);

                        const sessionsQuery = window.query(
                            window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`),
                            window.where('startTime', '>=', window.Timestamp.fromDate(startDate)),
                            window.where('startTime', '<=', window.Timestamp.fromDate(endDate))
                        );

                        const snapshot = await window.getDocs(sessionsQuery);
                        const monthlySessions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        monthlySessions.sort((a,b) => b.startTime.toMillis() - a.startTime.toMillis());
                        setSessions(monthlySessions);

                        const data = monthlySessions.reduce((acc, session) => {
                            acc[session.habitName] = (acc[session.habitName] || 0) + session.duration;
                            return acc;
                        }, {});
                        
                        const formattedData = Object.entries(data).map(([name, duration]) => ({ name, duration }));
                        setReportData(formattedData);

                    } catch (error) {
                        console.error("Error fetching report data:", error);
                        setNotification({ type: 'error', message: 'Failed to load report data.' });
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchReportData();
            }, [db, userId, month, appId, setNotification]);

            const handleDeleteSession = async (sessionId) => {
                if (window.confirm("Are you sure you want to delete this session? This cannot be undone.")) {
                    try {
                        const sessionDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/sessions/${sessionId}`);
                        await window.deleteDoc(sessionDocRef);
                        setNotification({ type: 'success', message: 'Session deleted successfully.' });
                        // Refresh data after deletion
                        const [year, monthNum] = month.split('-').map(Number);
                        const startDate = new Date(year, monthNum - 1, 1);
                        const endDate = new Date(year, monthNum, 0, 23, 59, 59);
                        const sessionsQuery = window.query(
                            window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`),
                            window.where('startTime', '>=', window.Timestamp.fromDate(startDate)),
                            window.where('startTime', '<=', window.Timestamp.fromDate(endDate))
                        );
                        const snapshot = await window.getDocs(sessionsQuery);
                        const monthlySessions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        monthlySessions.sort((a,b) => b.startTime.toMillis() - a.startTime.toMillis());
                        setSessions(monthlySessions);
                        const data = monthlySessions.reduce((acc, session) => {
                            acc[session.habitName] = (acc[session.habitName] || 0) + session.duration;
                            return acc;
                        }, {});
                        const formattedData = Object.entries(data).map(([name, duration]) => ({ name, duration }));
                        setReportData(formattedData);
                    } catch (error) {
                        console.error("Error deleting session:", error);
                        setNotification({ type: 'error', message: 'Failed to delete session.' });
                    }
                }
            };

            const maxDuration = Math.max(...reportData.map(d => d.duration), 0);
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl text-gray-800 mb-4", style: { fontWeight: 300 } }, "monthly report"),
                React.createElement('div', { className: "mb-6" },
                    React.createElement('label', { htmlFor: "month-select", className: "mr-2", style: { fontWeight: 400 } }, "select month:"),
                    React.createElement('input', {
                        type: "month",
                        id: "month-select",
                        value: month,
                        onChange: e => setMonth(e.target.value),
                        className: "p-2 border border-gray-300 rounded-lg"
                    })
                ),

                isLoading ? 
                    React.createElement('div', { className: "flex justify-center items-center p-8" },
                        React.createElement(LoaderIcon),
                        React.createElement('span', { className: "ml-2" }, "Generating report...")
                    ) :
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-8" },
                        // Chart Section
                        React.createElement('div', { className: "bg-white p-6 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl mb-4", style: { fontWeight: 300 } }, "habit totals"),
                            React.createElement('div', { className: "space-y-4" },
                                reportData.length > 0 ? reportData.map((item, index) =>
                                    React.createElement('div', { key: item.name },
                                        React.createElement('div', { className: "flex justify-between mb-1 text-sm", style: { fontWeight: 400 } },
                                            React.createElement('span', null, item.name),
                                            React.createElement('span', null, formatTime(item.duration))
                                        ),
                                        React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-4" },
                                            React.createElement('div', {
                                                className: `${colors[index % colors.length]} h-4 rounded-full`,
                                                style: { width: `${maxDuration > 0 ? (item.duration / maxDuration) * 100 : 0}%` }
                                            })
                                        )
                                    )
                                ) : React.createElement('p', null, "No data for this month.")
                            )
                        ),

                        // Sessions List
                        React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl mb-4", style: { fontWeight: 300 } }, "session log"),
                            React.createElement('div', { className: "space-y-3 max-h-[400px] overflow-y-auto" },
                                sessions.length > 0 ? sessions.map(session =>
                                    React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0 flex items-center justify-between gap-2" },
                                        React.createElement('div', { className: "flex-grow" },
                                            React.createElement('p', { style: { fontWeight: 400 } }, session.habitName),
                                            React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                                React.createElement('span', null, formatDate(session.startTime)),
                                                React.createElement('span', null, formatTime(session.duration))
                                            )
                                        ),
                                        React.createElement('button', {
                                            onClick: () => handleDeleteSession(session.id),
                                            className: "p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition flex-shrink-0",
                                            title: "Delete session"
                                        },
                                            React.createElement(TrashIcon)
                                        )
                                    )
                                ) :
                                React.createElement('p', { className: "text-gray-500" }, "No sessions recorded this month.")
                            )
                        )
                    )
            );
        };

        const Settings = ({ auth, userId, db, userProfile, setNotification }) => {
            const [username, setUsername] = useState('');
            const [isEditingUsername, setIsEditingUsername] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [isResetting, setIsResetting] = useState(false);

            useEffect(() => {
                if (userProfile?.username) {
                    setUsername(userProfile.username);
                }
            }, [userProfile]);

            const handleSaveUsername = async () => {
                if (!username.trim() || username === userProfile?.username) {
                    setIsEditingUsername(false);
                    return;
                }

                try {
                    const usersQuery = window.query(
                        window.collection(db, 'users'),
                        window.where('username', '==', username.trim())
                    );
                    const snapshot = await window.getDocs(usersQuery);

                    if (!snapshot.empty && snapshot.docs[0].id !== userId) {
                        setNotification({ type: 'error', message: 'Username already taken.' });
                        setUsername(userProfile?.username || '');
                        setIsEditingUsername(false);
                        return;
                    }

                    const userDocRef = window.doc(db, 'users', userId);
                    await window.setDoc(userDocRef, {
                        username: username.trim()
                    }, { merge: true });

                    setNotification({ type: 'success', message: 'Username updated!' });
                    setIsEditingUsername(false);
                } catch (error) {
                    console.error("Error updating username:", error);
                    setNotification({ type: 'error', message: 'Failed to update username.' });
                    setIsEditingUsername(false);
                }
            };

            const handleLogout = () => {
                window.signOut(auth);
            };

            const handleResetProgress = async () => {
                setIsResetting(true);
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const batch = window.writeBatch(db);

                    // Delete all sessions
                    const sessionsQuery = window.query(
                        window.collection(db, `artifacts/${appId}/users/${userId}/sessions`)
                    );
                    const sessionsSnapshot = await window.getDocs(sessionsQuery);
                    sessionsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Delete all habits
                    const habitsQuery = window.query(
                        window.collection(db, `artifacts/${appId}/users/${userId}/habits`)
                    );
                    const habitsSnapshot = await window.getDocs(habitsQuery);
                    habitsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Delete all goals
                    const goalsQuery = window.query(
                        window.collection(db, `artifacts/${appId}/users/${userId}/goals`)
                    );
                    const goalsSnapshot = await window.getDocs(goalsQuery);
                    goalsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Reset user document stats
                    const userDocRef = window.doc(db, `artifacts/${appId}/users/${userId}`);
                    batch.set(userDocRef, {
                        treeName: '',
                        treeType: 'seedling',
                        updatedAt: window.Timestamp.now()
                    }, { merge: true });

                    // Reset user profile stats
                    const userProfileRef = window.doc(db, 'users', userId);
                    batch.set(userProfileRef, {
                        stats: {
                            totalHours: 0,
                            currentStreak: 0,
                            totalSessions: 0,
                            goalsCompleted: 0,
                            treeLevel: 0,
                            lastUpdated: window.Timestamp.now()
                        }
                    }, { merge: true });

                    await batch.commit();

                    setNotification({ type: 'success', message: 'All progress has been reset!' });
                    setShowResetConfirm(false);

                    // Reload page after 1 second to show fresh state
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (error) {
                    console.error("Error resetting progress:", error);
                    setNotification({ type: 'error', message: 'Failed to reset progress: ' + error.message });
                } finally {
                    setIsResetting(false);
                }
            };

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl text-gray-800 mb-6", style: { fontWeight: 300 } }, "settings"),

                // Profile Section
                React.createElement('div', { className: "bg-white rounded-lg shadow-sm p-6 mb-6" },
                    React.createElement('h3', { className: "text-xl text-gray-700 mb-4", style: { fontWeight: 400 } }, "profile"),
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('div', { className: "flex justify-between items-center py-2 border-b" },
                            React.createElement('span', { className: "text-gray-600" }, "Username:"),
                            isEditingUsername ?
                                React.createElement('input', {
                                    type: "text",
                                    value: username,
                                    onChange: (e) => setUsername(e.target.value),
                                    onBlur: handleSaveUsername,
                                    onKeyPress: (e) => e.key === 'Enter' && handleSaveUsername(),
                                    autoFocus: true,
                                    className: "border px-2 py-1 rounded focus:ring-2 focus:ring-blue-500 focus:outline-none",
                                    placeholder: "username"
                                }) :
                                React.createElement('span', {
                                    className: "text-gray-800 cursor-pointer hover:text-blue-600 transition",
                                    onClick: () => setIsEditingUsername(true),
                                    title: "Click to edit"
                                }, `@${userProfile?.username || 'loading...'}`)
                        ),
                        React.createElement('div', { className: "flex justify-between items-center py-2" },
                            React.createElement('span', { className: "text-gray-600" }, "Friend Code:"),
                            React.createElement('span', { className: "font-mono text-sm text-gray-800" }, userProfile?.friendCode || 'Loading...')
                        )
                    )
                ),

                // Account Information Section
                React.createElement('div', { className: "bg-white rounded-lg shadow-sm p-6 mb-6" },
                    React.createElement('h3', { className: "text-xl text-gray-700 mb-4", style: { fontWeight: 400 } }, "account information"),
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('div', { className: "flex justify-between items-center py-2 border-b" },
                            React.createElement('span', { className: "text-gray-600" }, "User ID:"),
                            React.createElement('span', { className: "font-mono text-sm text-gray-800 truncate ml-4" }, userId)
                        ),
                        React.createElement('div', { className: "flex justify-between items-center py-2 border-b" },
                            React.createElement('span', { className: "text-gray-600" }, "Email:"),
                            React.createElement('span', { className: "text-gray-800" }, auth.currentUser?.email || 'Guest User')
                        ),
                        React.createElement('div', { className: "flex justify-between items-center py-2" },
                            React.createElement('span', { className: "text-gray-600" }, "Account Type:"),
                            React.createElement('span', { className: "text-gray-800" }, auth.currentUser?.isAnonymous ? 'Guest' : 'Registered')
                        )
                    )
                ),

                // Actions Section
                React.createElement('div', { className: "bg-white rounded-lg shadow-sm p-6" },
                    React.createElement('h3', { className: "text-xl text-gray-700 mb-4", style: { fontWeight: 400 } }, "actions"),
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('button', {
                            onClick: handleLogout,
                            className: "w-full sm:w-auto bg-red-600 text-white py-2 px-6 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2",
                            style: { fontWeight: 400 }
                        },
                            React.createElement(LogOutIcon),
                            "sign out"
                        ),
                        React.createElement('button', {
                            onClick: () => setShowResetConfirm(true),
                            className: "w-full sm:w-auto bg-gray-700 text-white py-2 px-6 rounded-lg hover:bg-gray-800 transition flex items-center justify-center gap-2",
                            style: { fontWeight: 400 }
                        },
                            React.createElement(XIcon),
                            "reset all progress"
                        )
                    )
                ),

                // Reset Confirmation Modal
                showResetConfirm && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",
                    onClick: () => !isResetting && setShowResetConfirm(false)
                },
                    React.createElement('div', {
                        className: "bg-white rounded-xl p-8 max-w-md m-4 soft-shadow-lg",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('h3', {
                            className: "text-2xl text-gray-800 mb-4",
                            style: { fontWeight: 400 }
                        }, "are you sure?"),
                        React.createElement('p', {
                            className: "text-gray-600 mb-6",
                            style: { fontWeight: 300 }
                        }, "This will permanently delete all your habits, sessions, goals, and reset your tree progress. This action cannot be undone."),
                        React.createElement('div', { className: "flex gap-3 justify-end" },
                            React.createElement('button', {
                                onClick: () => setShowResetConfirm(false),
                                disabled: isResetting,
                                className: "px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition disabled:opacity-50",
                                style: { fontWeight: 400 }
                            }, "cancel"),
                            React.createElement('button', {
                                onClick: handleResetProgress,
                                disabled: isResetting,
                                className: "px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:opacity-50 flex items-center gap-2",
                                style: { fontWeight: 400 }
                            },
                                isResetting && React.createElement(LoaderIcon),
                                isResetting ? "resetting..." : "yes, reset everything"
                            )
                        )
                    )
                )
            );
        };

        // About Component - Information about Nous philosophy and the app
        const About = () => {
            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('div', { className: "text-center mb-8" },
                    React.createElement('h1', { className: "text-4xl text-calm-800", style: { fontWeight: 300, letterSpacing: '0.05em' } }, "about")
                ),

                // Philosophy Section
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-8 mb-6" },
                    React.createElement('h2', { className: "text-2xl text-calm-800 mb-4", style: { fontWeight: 400 } }, "what is nous?"),
                    React.createElement('div', { className: "space-y-4 text-calm-700", style: { lineHeight: '1.8' } },
                        React.createElement('p', { style: { fontWeight: 300 } },
                            "In ancient Greek philosophy, ",
                            React.createElement('span', { className: "italic text-accent-blue", style: { fontWeight: 400 } }, "nous"),
                            " () represents the highest form of intellectthe faculty of intuitive understanding and contemplative reason. It is the part of us that grasps fundamental truths, sees patterns, and comprehends the essence of things."
                        ),
                        React.createElement('p', { style: { fontWeight: 300 } },
                            "Aristotle described nous as the aspect of mind that allows us to understand first principles. Plato saw it as the eye of the soul, the capacity for deep insight and clear thinking."
                        )
                    )
                ),

                // How Nous Helps Section
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-8 mb-6" },
                    React.createElement('h2', { className: "text-2xl text-calm-800 mb-4", style: { fontWeight: 400 } }, "cultivating your nous"),
                    React.createElement('div', { className: "space-y-6" },
                        React.createElement('div', null,
                            React.createElement('h3', { className: "text-lg text-accent-blue mb-2", style: { fontWeight: 400 } }, "mindful habit building"),
                            React.createElement('p', { className: "text-calm-700", style: { fontWeight: 300, lineHeight: '1.8' } },
                                "Nous helps you build habits with intention and awareness. By tracking your time and progress, you develop a clearer understanding of how you spend your daysthe foundation of a well-lived life."
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h3', { className: "text-lg text-accent-blue mb-2", style: { fontWeight: 400 } }, "growth through reflection"),
                            React.createElement('p', { className: "text-calm-700", style: { fontWeight: 300, lineHeight: '1.8' } },
                                "Like a tree growing from consistent nourishment, your skills and character develop through steady, deliberate practice. Nous visualizes this growth, helping you see the cumulative power of small, daily actions."
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h3', { className: "text-lg text-accent-blue mb-2", style: { fontWeight: 400 } }, "purposeful living"),
                            React.createElement('p', { className: "text-calm-700", style: { fontWeight: 300, lineHeight: '1.8' } },
                                "By setting goals and tracking progress, you align your daily actions with your deeper aspirations."
                            )
                        ),
                        React.createElement('div', null,
                            React.createElement('h3', { className: "text-lg text-accent-blue mb-2", style: { fontWeight: 400 } }, "community and connection"),
                            React.createElement('p', { className: "text-calm-700", style: { fontWeight: 300, lineHeight: '1.8' } },
                                "Connect with friends, share your journey, and inspire each other toward excellence. Together, we cultivate wisdom and support each other's flourishing."
                            )
                        )
                    )
                ),

                // Quote Section
                React.createElement('div', { className: "bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-8 mb-6 border-l-4", style: { borderColor: '#6B8DD6' } },
                    React.createElement('blockquote', { className: "text-center" },
                        React.createElement('p', { className: "text-xl text-calm-800 italic mb-3", style: { fontWeight: 300, lineHeight: '1.8' } },
                            '"We are what we repeatedly do. Excellence, then, is not an act, but a habit."'
                        ),
                        React.createElement('cite', { className: "text-calm-600", style: { fontWeight: 300 } }, " Aristotle")
                    )
                ),

                // Footer
                React.createElement('div', { className: "text-center mt-8 text-calm-600", style: { fontWeight: 300 } },
                    React.createElement('p', null, "Start your journey toward a more intentional life."),
                    React.createElement('p', { className: "mt-2 text-sm" }, "Powered by nous.")
                )
            );
        };

        // Growth Tree Component - Aesthetic visualization of study progress
        const GrowthTree = ({ sessions, db, userId, setNotification }) => {
            const [treeName, setTreeName] = useState('My Tree');
            const [selectedTreeType, setSelectedTreeType] = useState('seedling');
            const [isEditingName, setIsEditingName] = useState(false);
            const [tempName, setTempName] = useState('');

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // Calculate growth metrics
            const totalHours = calculateTotalHours(sessions);
            const growthPercent = getTreeGrowth(totalHours);
            const unlockedTrees = getUnlockedTrees(totalHours);
            const currentTree = TREE_TYPES.find(t => t.id === selectedTreeType) || TREE_TYPES[0];

            // Load tree preferences
            useEffect(() => {
                if (!db || !userId) return;
                const userDoc = window.doc(db, `artifacts/${appId}/users/${userId}`);
                window.onSnapshot(userDoc, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.treeName) setTreeName(data.treeName);
                        if (data.treeType) setSelectedTreeType(data.treeType);
                    }
                });
            }, [db, userId, appId]);

            // Save tree name
            const handleSaveName = async () => {
                if (tempName.trim()) {
                    try {
                        const userDoc = window.doc(db, `artifacts/${appId}/users/${userId}`);
                        await window.setDoc(userDoc, { treeName: tempName.trim(), treeType: selectedTreeType }, { merge: true });
                        setTreeName(tempName.trim());
                        setIsEditingName(false);
                    } catch (error) {
                        console.error("Error saving tree name:", error);
                    }
                }
            };

            // Change tree type
            const handleChangeTree = async (treeId) => {
                try {
                    const userDoc = window.doc(db, `artifacts/${appId}/users/${userId}`);
                    await window.setDoc(userDoc, { treeName: treeName, treeType: treeId }, { merge: true });
                    setSelectedTreeType(treeId);
                    setNotification({ type: 'success', message: `Changed to ${TREE_TYPES.find(t => t.id === treeId).name}!` });
                } catch (error) {
                    console.error("Error changing tree:", error);
                }
            };

            // Beautiful Tree SVG with crisp animations
            const TreeSVG = ({ growth, color, treeType }) => {
                const [animationKey, setAnimationKey] = useState(0);
                const prevGrowthRef = useRef(growth);

                // Trigger re-animation when growth increases significantly
                useEffect(() => {
                    if (growth > prevGrowthRef.current + 5) {
                        setAnimationKey(prev => prev + 1);
                    }
                    prevGrowthRef.current = growth;
                }, [growth]);

                // Calculate growth stages (0-1 normalized)
                const normalizedGrowth = Math.min(growth / 100, 1);
                const trunkGrowth = Math.min(normalizedGrowth / 0.2, 1); // 0-20%
                const branchGrowth = Math.max(0, Math.min((normalizedGrowth - 0.2) / 0.4, 1)); // 20-60%
                const leafGrowth = Math.max(0, Math.min((normalizedGrowth - 0.6) / 0.35, 1)); // 60-95%
                const fruitGrowth = normalizedGrowth >= 0.95 ? 1 : 0;

                // Enhanced colors with depth and variety - Minecraft-inspired
                // Trunk colors with more variety (browns, greys, reddish tones)
                const trunkDark = "#6B5947";    // Dark brown
                const trunkMid = "#8B7355";      // Medium brown
                const trunkLight = "#A0826D";    // Light brown
                const trunkGrey = "#736B5E";     // Grey-brown (birch-inspired)
                const trunkRed = "#A85C4A";      // Reddish brown (jungle-inspired)
                const trunkOrange = "#C97A3D";   // Orange-brown (acacia-inspired)

                // Dynamic leaf colors based on tree type (specific to each tree)
                let leafColors;
                if (treeType === 'sakura') {
                    // Ancient Sakura: Pink and bright purple
                    leafColors = ["#fda4af", "#fb7185", "#f472b6", "#c084fc", "#e879f9"];
                } else if (treeType === 'cherry') {
                    // Cherry Blossom: Pink shades
                    leafColors = ["#fda4af", "#fb7185", "#f472b6", "#fbbf24", "#fce7f3"];
                } else if (treeType === 'willow') {
                    // Willow: Grey tones
                    leafColors = ["#9ca3af", "#6b7280", "#d1d5db", "#9ca3af", "#6b7280"];
                } else if (treeType === 'pine') {
                    // Pine: Dark green tones
                    leafColors = ["#14532d", "#166534", "#15803d", "#16a34a", "#22c55e"];
                } else {
                    // Oak, Seedling, and others: Minecraft oak/jungle leaf greens
                    leafColors = ["#48b518", "#5ec920", "#3fa014", "#6ed528", "#58b61c"];
                }

                // Minecraft-inspired fruit colors (apples, berries, cocoa)
                const fruitColors = [
                    "#DC143C", // Apple red (drops from oak trees)
                    "#E74C3C", // Sweet berry red-orange
                    "#F9CA24", // Glow berry golden/amber
                ];

                // Enhanced branch paths with Minecraft-inspired color variety
                const branches = [
                    // Main branches - larger, thicker with varied colors
                    { d: "M100,120 Q85,105 75,85 Q70,75 68,65", width: 5, color: trunkDark, delay: 0, visible: branchGrowth > 0 },
                    { d: "M100,120 Q115,105 125,85 Q130,75 132,65", width: 5, color: trunkRed, delay: 0.05, visible: branchGrowth > 0.1 },
                    { d: "M100,115 Q80,100 70,80 Q65,70 62,60", width: 4, color: trunkMid, delay: 0.1, visible: branchGrowth > 0.2 },
                    { d: "M100,115 Q120,100 130,80 Q135,70 138,60", width: 4, color: trunkOrange, delay: 0.15, visible: branchGrowth > 0.3 },

                    // Secondary branches - medium with more color variety
                    { d: "M100,105 Q88,92 78,75 Q75,68 72,58", width: 3, color: trunkMid, delay: 0.2, visible: branchGrowth > 0.4 },
                    { d: "M100,105 Q112,92 122,75 Q125,68 128,58", width: 3, color: trunkGrey, delay: 0.25, visible: branchGrowth > 0.5 },
                    { d: "M100,100 Q92,88 85,72 Q82,65 80,55", width: 3, color: trunkLight, delay: 0.3, visible: branchGrowth > 0.6 },
                    { d: "M100,100 Q108,88 115,72 Q118,65 120,55", width: 3, color: trunkRed, delay: 0.35, visible: branchGrowth > 0.65 },

                    // Tertiary branches - smaller with varied tones
                    { d: "M75,85 Q70,78 65,68", width: 2, color: trunkLight, delay: 0.4, visible: branchGrowth > 0.7 },
                    { d: "M125,85 Q130,78 135,68", width: 2, color: trunkOrange, delay: 0.42, visible: branchGrowth > 0.7 },
                    { d: "M78,75 Q74,68 70,58", width: 2, color: trunkGrey, delay: 0.45, visible: branchGrowth > 0.75 },
                    { d: "M122,75 Q126,68 130,58", width: 2, color: trunkLight, delay: 0.47, visible: branchGrowth > 0.75 },

                    // Quaternary branches - extra fine detail for fuller canopy
                    { d: "M68,65 Q64,58 60,50", width: 1.5, color: trunkGrey, delay: 0.5, visible: branchGrowth > 0.8 },
                    { d: "M132,65 Q136,58 140,50", width: 1.5, color: trunkLight, delay: 0.52, visible: branchGrowth > 0.8 },
                    { d: "M70,58 Q67,52 64,45", width: 1.5, color: trunkOrange, delay: 0.54, visible: branchGrowth > 0.85 },
                    { d: "M130,58 Q133,52 136,45", width: 1.5, color: trunkGrey, delay: 0.56, visible: branchGrowth > 0.85 },
                ];

                // Enhanced leaf positions with size and color variety
                const leaves = [
                    // Top cluster
                    { x: 100, y: 48, size: 14, color: leafColors[0], delay: 0, visible: leafGrowth > 0 },
                    { x: 95, y: 52, size: 12, color: leafColors[1], delay: 0.02, visible: leafGrowth > 0.05 },
                    { x: 105, y: 52, size: 12, color: leafColors[2], delay: 0.04, visible: leafGrowth > 0.1 },
                    { x: 90, y: 56, size: 10, color: leafColors[3], delay: 0.06, visible: leafGrowth > 0.15 },
                    { x: 110, y: 56, size: 10, color: leafColors[4], delay: 0.08, visible: leafGrowth > 0.2 },

                    // Upper-middle clusters
                    { x: 82, y: 60, size: 13, color: leafColors[0], delay: 0.1, visible: leafGrowth > 0.25 },
                    { x: 118, y: 60, size: 13, color: leafColors[1], delay: 0.12, visible: leafGrowth > 0.3 },
                    { x: 75, y: 64, size: 11, color: leafColors[2], delay: 0.14, visible: leafGrowth > 0.35 },
                    { x: 125, y: 64, size: 11, color: leafColors[3], delay: 0.16, visible: leafGrowth > 0.4 },
                    { x: 88, y: 65, size: 10, color: leafColors[4], delay: 0.18, visible: leafGrowth > 0.42 },
                    { x: 112, y: 65, size: 10, color: leafColors[0], delay: 0.2, visible: leafGrowth > 0.44 },

                    // Middle section - denser
                    { x: 70, y: 68, size: 12, color: leafColors[1], delay: 0.22, visible: leafGrowth > 0.46 },
                    { x: 130, y: 68, size: 12, color: leafColors[2], delay: 0.24, visible: leafGrowth > 0.48 },
                    { x: 80, y: 70, size: 14, color: leafColors[3], delay: 0.26, visible: leafGrowth > 0.5 },
                    { x: 120, y: 70, size: 14, color: leafColors[4], delay: 0.28, visible: leafGrowth > 0.52 },
                    { x: 92, y: 72, size: 11, color: leafColors[0], delay: 0.3, visible: leafGrowth > 0.54 },
                    { x: 108, y: 72, size: 11, color: leafColors[1], delay: 0.32, visible: leafGrowth > 0.56 },
                    { x: 65, y: 75, size: 10, color: leafColors[2], delay: 0.34, visible: leafGrowth > 0.58 },
                    { x: 135, y: 75, size: 10, color: leafColors[3], delay: 0.36, visible: leafGrowth > 0.6 },

                    // Lower-middle clusters
                    { x: 75, y: 78, size: 13, color: leafColors[4], delay: 0.38, visible: leafGrowth > 0.62 },
                    { x: 125, y: 78, size: 13, color: leafColors[0], delay: 0.4, visible: leafGrowth > 0.64 },
                    { x: 85, y: 80, size: 12, color: leafColors[1], delay: 0.42, visible: leafGrowth > 0.66 },
                    { x: 115, y: 80, size: 12, color: leafColors[2], delay: 0.44, visible: leafGrowth > 0.68 },
                    { x: 78, y: 83, size: 10, color: leafColors[3], delay: 0.46, visible: leafGrowth > 0.7 },
                    { x: 122, y: 83, size: 10, color: leafColors[4], delay: 0.48, visible: leafGrowth > 0.72 },

                    // Lower outer leaves
                    { x: 68, y: 85, size: 11, color: leafColors[0], delay: 0.5, visible: leafGrowth > 0.74 },
                    { x: 132, y: 85, size: 11, color: leafColors[1], delay: 0.52, visible: leafGrowth > 0.76 },
                    { x: 72, y: 88, size: 9, color: leafColors[2], delay: 0.54, visible: leafGrowth > 0.78 },
                    { x: 128, y: 88, size: 9, color: leafColors[3], delay: 0.56, visible: leafGrowth > 0.8 },
                    { x: 90, y: 86, size: 10, color: leafColors[4], delay: 0.58, visible: leafGrowth > 0.85 },
                    { x: 110, y: 86, size: 10, color: leafColors[0], delay: 0.6, visible: leafGrowth > 0.9 },

                    // Additional outer leaves for fuller canopy
                    { x: 60, y: 78, size: 10, color: leafColors[1], delay: 0.62, visible: leafGrowth > 0.82 },
                    { x: 140, y: 78, size: 10, color: leafColors[2], delay: 0.64, visible: leafGrowth > 0.84 },
                    { x: 63, y: 70, size: 9, color: leafColors[3], delay: 0.66, visible: leafGrowth > 0.86 },
                    { x: 137, y: 70, size: 9, color: leafColors[4], delay: 0.68, visible: leafGrowth > 0.88 },
                    { x: 98, y: 58, size: 11, color: leafColors[0], delay: 0.7, visible: leafGrowth > 0.87 },
                    { x: 102, y: 58, size: 11, color: leafColors[1], delay: 0.72, visible: leafGrowth > 0.89 },
                    { x: 76, y: 82, size: 12, color: leafColors[2], delay: 0.74, visible: leafGrowth > 0.91 },
                    { x: 124, y: 82, size: 12, color: leafColors[3], delay: 0.76, visible: leafGrowth > 0.92 },
                    { x: 86, y: 76, size: 10, color: leafColors[4], delay: 0.78, visible: leafGrowth > 0.93 },
                    { x: 114, y: 76, size: 10, color: leafColors[0], delay: 0.8, visible: leafGrowth > 0.94 },
                    { x: 94, y: 68, size: 9, color: leafColors[1], delay: 0.82, visible: leafGrowth > 0.95 },
                    { x: 106, y: 68, size: 9, color: leafColors[2], delay: 0.84, visible: leafGrowth > 0.96 },
                ];

                // Minecraft-style fruits (apples, sweet berries, glow berries) - hidden for seedlings and pine
                const fruits = (fruitGrowth > 0 && treeType !== 'seedling' && treeType !== 'pine') ? [
                    { x: 100, y: 55, size: 4, color: fruitColors[0], delay: 0 },      // Apple (red)
                    { x: 88, y: 62, size: 3.5, color: fruitColors[1], delay: 0.1 },   // Sweet berry (orange-red)
                    { x: 112, y: 62, size: 3.5, color: fruitColors[2], delay: 0.15 }, // Glow berry (golden)
                    { x: 78, y: 68, size: 3, color: fruitColors[0], delay: 0.2 },     // Apple
                    { x: 122, y: 68, size: 3, color: fruitColors[1], delay: 0.25 },   // Sweet berry
                    { x: 95, y: 70, size: 3.5, color: fruitColors[2], delay: 0.3 },   // Glow berry
                    { x: 105, y: 70, size: 3.5, color: fruitColors[0], delay: 0.35 }, // Apple
                ] : [];

                return React.createElement('svg', {
                    viewBox: "0 0 200 200",
                    className: "w-full h-full",
                    key: animationKey,
                    style: { overflow: 'visible' }
                },
                    // Define reusable symbols for performance
                    React.createElement('defs', null,
                        // Leaf symbol
                        React.createElement('symbol', { id: 'leaf', viewBox: '0 0 10 10' },
                            React.createElement('ellipse', {
                                cx: "5", cy: "5", rx: "4", ry: "6",
                                fill: leafColors[0],
                                transform: "rotate(-20 5 5)"
                            })
                        ),
                        // Sparkle symbol
                        React.createElement('symbol', { id: 'sparkle', viewBox: '0 0 10 10' },
                            React.createElement('path', {
                                d: "M5,0 L6,4 L10,5 L6,6 L5,10 L4,6 L0,5 L4,4 Z",
                                fill: "#fbbf24",
                                opacity: "0.6"
                            })
                        ),
                        // Animation keyframes via CSS
                        React.createElement('style', null, `
                            @keyframes sway {
                                0%, 100% { transform: rotate(-2deg); }
                                50% { transform: rotate(2deg); }
                            }
                            @keyframes leafPop {
                                0% { transform: scale(0); opacity: 0; }
                                70% { transform: scale(1.15); opacity: 1; }
                                100% { transform: scale(1); opacity: 1; }
                            }
                            @keyframes fruitGlow {
                                0%, 100% { opacity: 0.8; }
                                50% { opacity: 1; }
                            }
                            @media (prefers-reduced-motion: reduce) {
                                .tree-sway { animation: none !important; }
                                .leaf-pop { animation: none !important; opacity: 1 !important; transform: scale(1) !important; }
                                .branch-draw { animation: none !important; stroke-dashoffset: 0 !important; }
                            }
                        `)
                    ),

                    // Ground line
                    React.createElement('line', {
                        x1: "30", y1: "180", x2: "170", y2: "180",
                        stroke: "#e5e7eb",
                        strokeWidth: "3",
                        strokeLinecap: "round",
                        opacity: "0.5"
                    }),

                    // Main tree group with idle sway
                    React.createElement('g', {
                        className: trunkGrowth > 0.5 ? "tree-sway" : "",
                        style: {
                            transformOrigin: "100px 180px",
                            animation: trunkGrowth > 0.5 ? "sway 8s ease-in-out infinite" : "none",
                            willChange: "transform"
                        }
                    },
                        // Enhanced trunk with multiple colors for depth
                        React.createElement('g', null,
                            // Base trunk (darkest)
                            React.createElement('path', {
                                d: "M100,180 Q98,150 97,120 Q96,90 100,80",
                                stroke: trunkDark,
                                strokeWidth: "8",
                                strokeLinecap: "round",
                                fill: "none",
                                strokeDasharray: trunkGrowth > 0 ? "100" : "0",
                                strokeDashoffset: trunkGrowth > 0 ? `${100 - (trunkGrowth * 100)}` : "100",
                                style: {
                                    transition: "stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1)",
                                    willChange: "stroke-dashoffset"
                                }
                            }),
                            // Highlight on left side
                            React.createElement('path', {
                                d: "M98,180 Q96,150 95.5,120 Q95,90 98.5,80",
                                stroke: trunkLight,
                                strokeWidth: "2",
                                strokeLinecap: "round",
                                fill: "none",
                                strokeDasharray: trunkGrowth > 0 ? "100" : "0",
                                strokeDashoffset: trunkGrowth > 0 ? `${100 - (trunkGrowth * 100)}` : "100",
                                opacity: "0.6",
                                style: {
                                    transition: "stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1)",
                                    willChange: "stroke-dashoffset"
                                }
                            })
                        ),

                        // Enhanced branches with varied widths and colors
                        ...branches.map((branch, i) =>
                            branch.visible ? React.createElement('path', {
                                key: `branch-${i}`,
                                d: branch.d,
                                stroke: branch.color,
                                strokeWidth: branch.width.toString(),
                                strokeLinecap: "round",
                                fill: "none",
                                strokeDasharray: "50",
                                strokeDashoffset: "0",
                                className: "branch-draw",
                                style: {
                                    strokeDashoffset: `${50 - (branchGrowth * 50)}`,
                                    transition: `stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1) ${branch.delay}s`,
                                    willChange: "stroke-dashoffset",
                                    opacity: 0.9
                                }
                            }) : null
                        ),

                        // Enhanced leaves with varied colors and sizes
                        ...leaves.map((leaf, i) =>
                            leaf.visible ? React.createElement('ellipse', {
                                key: `leaf-${i}`,
                                cx: leaf.x,
                                cy: leaf.y,
                                rx: leaf.size * 0.35,
                                ry: leaf.size * 0.5,
                                fill: leaf.color,
                                transform: `rotate(-20 ${leaf.x} ${leaf.y})`,
                                className: "leaf-pop",
                                style: {
                                    animation: `leafPop 0.22s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${leaf.delay}s both`,
                                    transformOrigin: `${leaf.x}px ${leaf.y}px`,
                                    willChange: "transform, opacity",
                                    opacity: 0.85
                                }
                            }) : null
                        ),

                        // Enhanced fruits with varied colors, sizes, and details
                        ...fruits.map((fruit, i) =>
                            React.createElement('g', { key: `fruit-${i}` },
                                // Glow effect
                                React.createElement('circle', {
                                    cx: fruit.x,
                                    cy: fruit.y,
                                    r: fruit.size * 1.5,
                                    fill: fruit.color,
                                    opacity: "0.3",
                                    style: {
                                        filter: "blur(4px)",
                                        animation: "fruitGlow 2s ease-in-out infinite"
                                    }
                                }),
                                // Main fruit
                                React.createElement('circle', {
                                    cx: fruit.x,
                                    cy: fruit.y,
                                    r: fruit.size,
                                    fill: fruit.color,
                                    style: {
                                        animation: `leafPop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${fruit.delay}s both`
                                    }
                                }),
                                // Highlight on fruit
                                React.createElement('circle', {
                                    cx: fruit.x - fruit.size * 0.3,
                                    cy: fruit.y - fruit.size * 0.3,
                                    r: fruit.size * 0.35,
                                    fill: "#ffffff",
                                    opacity: "0.5",
                                    style: {
                                        animation: `leafPop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${fruit.delay}s both`
                                    }
                                }),
                                // Stem
                                React.createElement('line', {
                                    x1: fruit.x,
                                    y1: fruit.y - fruit.size,
                                    x2: fruit.x,
                                    y2: fruit.y - fruit.size - 2,
                                    stroke: trunkMid,
                                    strokeWidth: "1",
                                    strokeLinecap: "round",
                                    style: {
                                        animation: `leafPop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${fruit.delay + 0.05}s both`
                                    }
                                }),
                                // Sparkle
                                React.createElement('path', {
                                    d: `M${fruit.x},${fruit.y - fruit.size - 4} L${fruit.x + 1},${fruit.y - fruit.size - 2} L${fruit.x + 2.5},${fruit.y - fruit.size - 2.5} L${fruit.x + 1},${fruit.y - fruit.size - 3} L${fruit.x},${fruit.y - fruit.size - 5.5} L${fruit.x - 1},${fruit.y - fruit.size - 3} L${fruit.x - 2.5},${fruit.y - fruit.size - 2.5} L${fruit.x - 1},${fruit.y - fruit.size - 2} Z`,
                                    fill: "#fbbf24",
                                    opacity: "0.6",
                                    style: {
                                        animation: `leafPop 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) ${fruit.delay + 0.1}s both, fruitGlow 1.5s ease-in-out infinite`
                                    }
                                })
                            )
                        )
                    )
                );
            };

            return React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                // Header
                React.createElement('div', { className: "flex justify-between items-center mb-4" },
                    isEditingName ?
                        React.createElement('input', {
                            type: "text",
                            value: tempName,
                            onChange: e => setTempName(e.target.value),
                            onBlur: handleSaveName,
                            onKeyPress: e => e.key === 'Enter' && handleSaveName(),
                            autoFocus: true,
                            className: "text-xl font-light text-calm-800 border-b-2 border-calm-300 focus:border-calm-600 outline-none",
                            style: { fontWeight: 300 }
                        }) :
                        React.createElement('h3', {
                            className: "text-xl text-calm-800 cursor-pointer hover:text-calm-600 transition",
                            style: { fontWeight: 300 },
                            onClick: () => {
                                setTempName(treeName);
                                setIsEditingName(true);
                            }
                        }, treeName),
                    React.createElement('span', {
                        className: "text-sm text-calm-500",
                        style: { fontWeight: 300 }
                    }, `${totalHours.toFixed(1)}h`)
                ),

                // Tree visualization
                React.createElement('div', { className: "relative bg-gradient-to-b from-blue-50 to-green-50 rounded-lg p-4 mb-4", style: { height: '240px' } },
                    React.createElement(TreeSVG, { growth: growthPercent, color: currentTree.color, treeType: currentTree.id }),

                    // Growth percentage badge
                    React.createElement('div', {
                        className: "absolute top-2 right-2 bg-white px-3 py-1 rounded-full text-sm soft-shadow",
                        style: { fontWeight: 300, color: currentTree.color }
                    }, `${Math.min(100, Math.round(growthPercent))}% grown`)
                ),

                // Progress bar
                React.createElement('div', { className: "mb-4" },
                    React.createElement('div', { className: "flex justify-between text-xs text-calm-600 mb-1", style: { fontWeight: 300 } },
                        React.createElement('span', null, currentTree.name),
                        React.createElement('span', null, `${totalHours.toFixed(1)} / 5.0 hours`)
                    ),
                    React.createElement('div', { className: "w-full bg-calm-200 rounded-full h-2" },
                        React.createElement('div', {
                            className: "h-2 rounded-full transition-all duration-1000",
                            style: {
                                width: `${Math.min(100, growthPercent)}%`,
                                backgroundColor: currentTree.color
                            }
                        })
                    )
                ),

                // Unlocked trees
                React.createElement('div', { className: "border-t border-calm-200 pt-4" },
                    React.createElement('p', {
                        className: "text-xs text-calm-600 mb-2",
                        style: { fontWeight: 300 }
                    }, `${unlockedTrees.length} of ${TREE_TYPES.length} trees unlocked`),

                    React.createElement('div', { className: "flex flex-wrap gap-2" },
                        TREE_TYPES.map(tree => {
                            const isUnlocked = unlockedTrees.some(t => t.id === tree.id);
                            const isSelected = tree.id === selectedTreeType;

                            return React.createElement('button', {
                                key: tree.id,
                                onClick: () => isUnlocked && handleChangeTree(tree.id),
                                disabled: !isUnlocked,
                                className: `px-3 py-1 rounded-lg text-xs transition ${
                                    isSelected ? 'ring-2' : ''
                                } ${
                                    !isUnlocked ? 'opacity-30 cursor-not-allowed' : 'hover:opacity-80 cursor-pointer'
                                }`,
                                style: {
                                    backgroundColor: tree.color + '20',
                                    color: tree.color,
                                    ringColor: tree.color,
                                    fontWeight: 300
                                },
                                title: isUnlocked ? tree.name : `Unlock at ${tree.requiredHours}h`
                            }, isUnlocked ? tree.name : ' ' + tree.name.split(' ')[0]);
                        })
                    )
                ),

                // Next unlock message
                unlockedTrees.length < TREE_TYPES.length && React.createElement('p', {
                    className: "text-xs text-calm-500 mt-3 text-center",
                    style: { fontWeight: 300 }
                }, `Study ${(TREE_TYPES[unlockedTrees.length].requiredHours - totalHours).toFixed(1)} more hours to unlock ${TREE_TYPES[unlockedTrees.length].name}`)
            );
        };

        // GoalSection component - moved outside Goals to prevent re-creation on each render
        const GoalSection = ({ type, title, color, placeholder, activeGoals, newGoalText, setNewGoalText, handleAddGoal, handleToggleGoal, handleDeleteGoal }) => {
            const sectionGoals = activeGoals.filter(g => g.type === type);

            return React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                React.createElement('h3', { className: "text-xl font-light mb-4", style: { color, fontWeight: 300 } }, title),

                // Goal input
                React.createElement('div', { className: "flex gap-2 mb-4" },
                    React.createElement('input', {
                        type: "text",
                        value: newGoalText[type],
                        onChange: (e) => setNewGoalText({ ...newGoalText, [type]: e.target.value }),
                        onKeyPress: (e) => e.key === 'Enter' && handleAddGoal(type),
                        placeholder,
                        className: "flex-grow px-4 py-2 border border-calm-300 rounded-xl focus:ring-2 focus:outline-none transition",
                        style: { borderColor: '#d1d7e3', fontWeight: 300 }
                    }),
                    React.createElement('button', {
                        onClick: () => handleAddGoal(type),
                        className: "px-4 py-2 rounded-xl soft-shadow hover:opacity-90 transition text-white",
                        style: { backgroundColor: color, fontWeight: 400 }
                    }, "+")
                ),

                // Goal list
                React.createElement('div', { className: "space-y-2" },
                    sectionGoals.map(goal =>
                        React.createElement('div', {
                            key: goal.id,
                            className: "flex items-center gap-3 p-2 rounded-lg hover:bg-calm-50 transition group"
                        },
                            React.createElement('input', {
                                type: "checkbox",
                                checked: false,
                                onChange: () => handleToggleGoal(goal),
                                className: "w-5 h-5 rounded border-calm-400 cursor-pointer"
                            }),
                            React.createElement('span', {
                                className: "flex-grow text-calm-800",
                                style: { fontWeight: 300 }
                            }, goal.text),
                            React.createElement('button', {
                                onClick: () => handleDeleteGoal(goal.id),
                                className: "opacity-0 group-hover:opacity-100 text-calm-400 hover:text-red-500 transition",
                                style: { fontSize: '0.9rem' }
                            }, "")
                        )
                    )
                )
            );
        };

        const Goals = ({ db, userId, setNotification }) => {
            const [goals, setGoals] = useState([]);
            const [newGoalText, setNewGoalText] = useState({ daily: '', weekly: '', monthly: '', yearly: '' });
            const [isLoading, setIsLoading] = useState(true);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;

                const goalsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/goals`);

                const unsubscribe = window.onSnapshot(goalsCol, (snapshot) => {
                    const goalsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setGoals(goalsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching goals:", error);
                    setNotification({ type: 'error', message: "Could not fetch goals." });
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, appId, setNotification]);

            const handleAddGoal = async (type) => {
                const text = newGoalText[type].trim();
                if (!text) return;

                try {
                    const goalsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/goals`);
                    await window.addDoc(goalsCol, {
                        text,
                        type,
                        completed: false,
                        createdAt: window.Timestamp.now()
                    });
                    setNewGoalText({ ...newGoalText, [type]: '' });
                    setNotification({ type: 'success', message: 'Goal added!' });
                } catch (error) {
                    console.error("Error adding goal:", error);
                    setNotification({ type: 'error', message: 'Failed to add goal.' });
                }
            };

            const handleToggleGoal = async (goal) => {
                try {
                    const goalDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/goals/${goal.id}`);
                    await window.setDoc(goalDocRef, {
                        ...goal,
                        completed: !goal.completed,
                        completedAt: !goal.completed ? window.Timestamp.now() : null
                    }, { merge: true });
                } catch (error) {
                    console.error("Error toggling goal:", error);
                    setNotification({ type: 'error', message: 'Failed to update goal.' });
                }
            };

            const handleDeleteGoal = async (goalId) => {
                try {
                    const goalDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/goals/${goalId}`);
                    await window.deleteDoc(goalDocRef);
                    setNotification({ type: 'success', message: 'Goal deleted!' });
                } catch (error) {
                    console.error("Error deleting goal:", error);
                    setNotification({ type: 'error', message: 'Failed to delete goal.' });
                }
            };

            const activeGoals = goals.filter(g => !g.completed);
            const completedGoals = goals.filter(g => g.completed).sort((a, b) =>
                (b.completedAt?.toMillis() || 0) - (a.completedAt?.toMillis() || 0)
            );

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading your goals...")
                );
            }

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl text-calm-800 mb-2", style: { fontWeight: 300 } }, "my goals"),
                React.createElement('p', { className: "text-calm-600 mb-6", style: { fontWeight: 300 } }, "set and track your goals"),

                React.createElement('div', { className: "space-y-6" },
                    React.createElement(GoalSection, {
                        type: 'daily',
                        title: 'daily goals',
                        color: '#5FA8A3',
                        placeholder: "what do you want to accomplish today?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'weekly',
                        title: 'weekly goals',
                        color: '#6B8DD6',
                        placeholder: "what do you want to accomplish this week?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'monthly',
                        title: 'monthly goals',
                        color: '#8B7FB8',
                        placeholder: "what do you want to accomplish this month?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'yearly',
                        title: 'yearly goals',
                        color: '#7d8ca8',
                        placeholder: "what do you want to accomplish this year?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),

                    // Completed Goals Section
                    completedGoals.length > 0 && React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6 mt-8" },
                        React.createElement('h3', { className: "text-xl text-calm-600 mb-4", style: { fontWeight: 300 } }, "completed goals"),
                        React.createElement('div', { className: "space-y-2" },
                            completedGoals.map(goal =>
                                React.createElement('div', {
                                    key: goal.id,
                                    className: "flex items-center gap-3 p-2 rounded-lg hover:bg-calm-50 transition group"
                                },
                                    React.createElement('input', {
                                        type: "checkbox",
                                        checked: true,
                                        onChange: () => handleToggleGoal(goal),
                                        className: "w-5 h-5 rounded border-calm-400 cursor-pointer"
                                    }),
                                    React.createElement('span', {
                                        className: "flex-grow text-calm-500 line-through",
                                        style: { fontWeight: 300 }
                                    }, goal.text),
                                    React.createElement('span', {
                                        className: "text-xs text-calm-400",
                                        style: { fontWeight: 300 }
                                    }, goal.completedAt ? formatDate(goal.completedAt) : ''),
                                    React.createElement('button', {
                                        onClick: () => handleDeleteGoal(goal.id),
                                        className: "opacity-0 group-hover:opacity-100 text-calm-400 hover:text-red-500 transition",
                                        style: { fontSize: '0.9rem' }
                                    }, "")
                                )
                            )
                        )
                    )
                )
            );
        };

        // --- Friends Page Component ---
        const Friends = ({ db, userId, setNotification, userProfile }) => {
            const [friendRequests, setFriendRequests] = useState([]);
            const [nousRequests, setNousRequests] = useState([]);
            const [friends, setFriends] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [friendCodeInput, setFriendCodeInput] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [isSearching, setIsSearching] = useState(false);

            // Load friend requests and friendships
            useEffect(() => {
                if (!db || !userId) return;

                // Listen to incoming friend requests
                const requestsQuery = window.query(
                    window.collection(db, 'friendRequests'),
                    window.where('toUserId', '==', userId),
                    window.where('status', '==', 'pending')
                );

                const unsubscribeRequests = window.onSnapshot(requestsQuery, async (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setFriendRequests(requests);
                });

                // Listen to incoming Nous requests
                const nousRequestsQuery = window.query(
                    window.collection(db, 'nousRequests'),
                    window.where('toUserId', '==', userId),
                    window.where('status', '==', 'pending')
                );

                const unsubscribeNousRequests = window.onSnapshot(nousRequestsQuery, async (snapshot) => {
                    const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setNousRequests(requests);
                });

                // Listen to friendships
                const friendshipsQuery1 = window.query(
                    window.collection(db, 'friendships'),
                    window.where('user1Id', '==', userId)
                );
                const friendshipsQuery2 = window.query(
                    window.collection(db, 'friendships'),
                    window.where('user2Id', '==', userId)
                );

                const fetchFriends = async () => {
                    try {
                        const [snap1, snap2] = await Promise.all([
                            window.getDocs(friendshipsQuery1),
                            window.getDocs(friendshipsQuery2)
                        ]);

                        const friendsList = [];

                        // Get friends from both queries
                        for (const doc of [...snap1.docs, ...snap2.docs]) {
                            const data = doc.data();
                            const friendId = data.user1Id === userId ? data.user2Id : data.user1Id;

                            // Fetch friend's user profile
                            const friendDocRef = window.doc(db, 'users', friendId);
                            const friendSnapshot = await window.getDoc(friendDocRef);
                            const friendData = friendSnapshot.data();

                            if (friendData) {
                                friendsList.push({
                                    id: doc.id,
                                    friendshipId: doc.id,
                                    userId: friendId,
                                    username: data.user1Id === userId ? data.user2Username : data.user1Username,
                                    ...friendData
                                });
                            }
                        }

                        setFriends(friendsList);
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching friends:", error);
                        setNotification({ type: 'error', message: 'Failed to load friends: ' + error.message });
                        setIsLoading(false);
                    }
                };

                fetchFriends();
                return () => {
                    unsubscribeRequests();
                    unsubscribeNousRequests();
                };
            }, [db, userId, setNotification]);

            // Search for user by username
            const handleSearchUsername = async () => {
                if (!searchTerm.trim()) return;
                setIsSearching(true);
                setSearchResult(null);

                try {
                    const usersQuery = window.query(
                        window.collection(db, 'users'),
                        window.where('username', '==', searchTerm.trim())
                    );
                    const snapshot = await window.getDocs(usersQuery);

                    if (!snapshot.empty) {
                        const userData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };

                        if (userData.id === userId) {
                            setNotification({ type: 'error', message: "You can't add yourself!" });
                        } else {
                            setSearchResult(userData);
                        }
                    } else {
                        setNotification({ type: 'error', message: 'User not found.' });
                    }
                } catch (error) {
                    console.error("Error searching user:", error);
                    setNotification({ type: 'error', message: 'Search failed.' });
                } finally {
                    setIsSearching(false);
                }
            };

            // Search by friend code
            const handleSearchByCode = async () => {
                if (!friendCodeInput.trim()) return;
                setIsSearching(true);
                setSearchResult(null);

                try {
                    const usersQuery = window.query(
                        window.collection(db, 'users'),
                        window.where('friendCode', '==', friendCodeInput.trim().toUpperCase())
                    );
                    const snapshot = await window.getDocs(usersQuery);

                    if (!snapshot.empty) {
                        const userData = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };

                        if (userData.id === userId) {
                            setNotification({ type: 'error', message: "That's your own code!" });
                        } else {
                            setSearchResult(userData);
                        }
                    } else {
                        setNotification({ type: 'error', message: 'Invalid friend code.' });
                    }
                } catch (error) {
                    console.error("Error searching by code:", error);
                    setNotification({ type: 'error', message: 'Search failed.' });
                } finally {
                    setIsSearching(false);
                }
            };

            // Send friend request
            const handleSendRequest = async (toUser) => {
                try {
                    // Check if request already exists
                    const existingQuery = window.query(
                        window.collection(db, 'friendRequests'),
                        window.where('fromUserId', '==', userId),
                        window.where('toUserId', '==', toUser.id)
                    );
                    const existing = await window.getDocs(existingQuery);

                    if (!existing.empty) {
                        setNotification({ type: 'error', message: 'Request already sent!' });
                        return;
                    }

                    await window.addDoc(window.collection(db, 'friendRequests'), {
                        fromUserId: userId,
                        fromUsername: userProfile?.username || 'Anonymous',
                        toUserId: toUser.id,
                        toUsername: toUser.username,
                        status: 'pending',
                        createdAt: window.Timestamp.now()
                    });

                    setNotification({ type: 'success', message: `Friend request sent to @${toUser.username}!` });
                    setSearchResult(null);
                    setSearchTerm('');
                    setFriendCodeInput('');
                } catch (error) {
                    console.error("Error sending request:", error);
                    setNotification({ type: 'error', message: 'Failed to send request.' });
                }
            };

            // Accept friend request
            const handleAcceptRequest = async (request) => {
                try {
                    // Update request status
                    const requestRef = window.doc(db, 'friendRequests', request.id);
                    await window.setDoc(requestRef, { status: 'accepted' }, { merge: true });

                    // Create friendship
                    await window.addDoc(window.collection(db, 'friendships'), {
                        user1Id: request.fromUserId,
                        user1Username: request.fromUsername,
                        user2Id: userId,
                        user2Username: userProfile?.username || 'Anonymous',
                        createdAt: window.Timestamp.now()
                    });

                    setNotification({ type: 'success', message: `You're now friends with @${request.fromUsername}!` });

                    // Refresh friends list
                    setFriendRequests(prev => prev.filter(r => r.id !== request.id));
                } catch (error) {
                    console.error("Error accepting request:", error);
                    setNotification({ type: 'error', message: 'Failed to accept request.' });
                }
            };

            // Decline friend request
            const handleDeclineRequest = async (request) => {
                try {
                    const requestRef = window.doc(db, 'friendRequests', request.id);
                    await window.setDoc(requestRef, { status: 'declined' }, { merge: true });
                    setFriendRequests(prev => prev.filter(r => r.id !== request.id));
                    setNotification({ type: 'success', message: 'Request declined.' });
                } catch (error) {
                    console.error("Error declining request:", error);
                    setNotification({ type: 'error', message: 'Failed to decline request.' });
                }
            };

            // Unfriend
            const handleUnfriend = async (friendship) => {
                if (!window.confirm(`Remove @${friendship.username} from friends?`)) return;

                try {
                    await window.deleteDoc(window.doc(db, 'friendships', friendship.friendshipId));
                    setFriends(prev => prev.filter(f => f.friendshipId !== friendship.friendshipId));
                    setNotification({ type: 'success', message: 'Friend removed.' });
                } catch (error) {
                    console.error("Error unfriending:", error);
                    setNotification({ type: 'error', message: 'Failed to remove friend.' });
                }
            };

            // Copy friend code
            const handleCopyCode = () => {
                if (userProfile?.friendCode) {
                    navigator.clipboard.writeText(userProfile.friendCode);
                    setNotification({ type: 'success', message: 'Friend code copied!' });
                }
            };

            // Send Nous together request
            const handleNousRequest = async (friend) => {
                try {
                    console.log('Attempting to send Nous request...');
                    console.log('Friend:', friend);
                    console.log('User ID:', userId);
                    console.log('User Profile:', userProfile);
                    console.log('Database:', db);

                    if (!db || !userId || !userProfile) {
                        console.error('Missing required data:', { db, userId, userProfile });
                        setNotification({ type: 'error', message: 'Missing required data. Please try refreshing the page.' });
                        return;
                    }

                    if (!userProfile.username) {
                        console.error('User profile missing username');
                        setNotification({ type: 'error', message: 'Your profile is incomplete. Please check your settings.' });
                        return;
                    }

                    // Check if there's already a pending request
                    console.log('Checking for existing requests...');
                    const existingQuery = window.query(
                        window.collection(db, 'nousRequests'),
                        window.where('fromUserId', '==', userId),
                        window.where('toUserId', '==', friend.userId),
                        window.where('status', '==', 'pending')
                    );
                    const existingDocs = await window.getDocs(existingQuery);

                    if (!existingDocs.empty) {
                        setNotification({ type: 'error', message: 'You already sent a Nous request to this friend!' });
                        return;
                    }

                    // Create Nous request
                    console.log('Creating Nous request...');
                    const requestData = {
                        fromUserId: userId,
                        fromUsername: userProfile.username,
                        toUserId: friend.userId,
                        toUsername: friend.username,
                        status: 'pending',
                        createdAt: window.Timestamp.now()
                    };
                    console.log('Request data:', requestData);

                    await window.addDoc(window.collection(db, 'nousRequests'), requestData);

                    console.log('Nous request sent successfully!');
                    setNotification({ type: 'success', message: `Nous request sent to @${friend.username}!` });
                } catch (error) {
                    console.error("Error sending Nous request:", error);
                    console.error("Error details:", error.message, error.code);
                    setNotification({ type: 'error', message: `Failed to send Nous request: ${error.message}` });
                }
            };

            // Accept Nous request
            const handleAcceptNousRequest = async (request) => {
                try {
                    const requestDocRef = window.doc(db, 'nousRequests', request.id);
                    await window.updateDoc(requestDocRef, {
                        status: 'accepted'
                    });
                    setNousRequests(prev => prev.filter(r => r.id !== request.id));
                    setNotification({ type: 'success', message: `You're now studying together with @${request.fromUsername}!` });
                } catch (error) {
                    console.error("Error accepting Nous request:", error);
                    setNotification({ type: 'error', message: 'Failed to accept request.' });
                }
            };

            // Decline Nous request
            const handleDeclineNousRequest = async (request) => {
                try {
                    const requestDocRef = window.doc(db, 'nousRequests', request.id);
                    await window.updateDoc(requestDocRef, {
                        status: 'declined'
                    });
                    setNousRequests(prev => prev.filter(r => r.id !== request.id));
                    setNotification({ type: 'success', message: 'Nous request declined.' });
                } catch (error) {
                    console.error("Error declining Nous request:", error);
                    setNotification({ type: 'error', message: 'Failed to decline request.' });
                }
            };

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading friends...")
                );
            }

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6" },
                // Header
                React.createElement('h2', { className: "text-3xl text-calm-800 mb-2", style: { fontWeight: 300 } }, "friends"),

                // Friend Code Card
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('div', { className: "flex justify-between items-center" },
                        React.createElement('div', null,
                            React.createElement('h3', { className: "text-sm text-calm-600 mb-1", style: { fontWeight: 300 } }, "my friend code"),
                            React.createElement('span', { className: "text-2xl font-mono text-calm-800", style: { fontWeight: 400, letterSpacing: '0.1em' } },
                                userProfile?.friendCode || 'Loading...'
                            )
                        ),
                        React.createElement('button', {
                            onClick: handleCopyCode,
                            className: "px-4 py-2 bg-calm-600 text-white rounded-lg hover:bg-calm-700 transition",
                            style: { fontWeight: 400 }
                        }, "Copy Code")
                    )
                ),

                // Add Friends Card
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('h3', { className: "text-xl text-calm-800 mb-4", style: { fontWeight: 300 } }, "add friends"),

                    // Search by username
                    React.createElement('div', { className: "mb-4" },
                        React.createElement('label', { className: "block text-sm text-calm-600 mb-2", style: { fontWeight: 300 } }, "search by username"),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('input', {
                                type: "text",
                                value: searchTerm,
                                onChange: (e) => setSearchTerm(e.target.value),
                                onKeyPress: (e) => e.key === 'Enter' && handleSearchUsername(),
                                placeholder: "Enter username...",
                                className: "flex-grow px-4 py-2 border border-calm-300 rounded-lg focus:ring-2 focus:ring-calm-500 focus:outline-none",
                                style: { fontWeight: 300 }
                            }),
                            React.createElement('button', {
                                onClick: handleSearchUsername,
                                disabled: isSearching,
                                className: "px-4 py-2 bg-calm-600 text-white rounded-lg hover:bg-calm-700 transition disabled:opacity-50",
                                style: { fontWeight: 400 }
                            }, React.createElement(SearchIcon))
                        )
                    ),

                    // Search by friend code
                    React.createElement('div', null,
                        React.createElement('label', { className: "block text-sm text-calm-600 mb-2", style: { fontWeight: 300 } }, "or add by friend code"),
                        React.createElement('div', { className: "flex gap-2" },
                            React.createElement('input', {
                                type: "text",
                                value: friendCodeInput,
                                onChange: (e) => setFriendCodeInput(e.target.value.toUpperCase()),
                                onKeyPress: (e) => e.key === 'Enter' && handleSearchByCode(),
                                placeholder: "ABC12345",
                                maxLength: 8,
                                className: "flex-grow px-4 py-2 border border-calm-300 rounded-lg focus:ring-2 focus:ring-calm-500 focus:outline-none font-mono",
                                style: { fontWeight: 300, letterSpacing: '0.1em' }
                            }),
                            React.createElement('button', {
                                onClick: handleSearchByCode,
                                disabled: isSearching,
                                className: "px-4 py-2 bg-calm-600 text-white rounded-lg hover:bg-calm-700 transition disabled:opacity-50",
                                style: { fontWeight: 400 }
                            }, "Add")
                        )
                    ),

                    // Search Result
                    searchResult && React.createElement('div', { className: "mt-4 p-4 bg-calm-50 rounded-lg border border-calm-200" },
                        React.createElement('div', { className: "flex justify-between items-center" },
                            React.createElement('div', null,
                                React.createElement('p', { className: "text-lg text-calm-800", style: { fontWeight: 400 } }, `@${searchResult.username}`),
                                React.createElement('p', { className: "text-sm text-calm-600", style: { fontWeight: 300 } },
                                    `${searchResult.stats?.totalHours?.toFixed(1) || 0}h studied`
                                )
                            ),
                            React.createElement('button', {
                                onClick: () => handleSendRequest(searchResult),
                                className: "px-4 py-2 bg-accent-blue text-white rounded-lg hover:opacity-90 transition",
                                style: { fontWeight: 400, backgroundColor: '#6B8DD6' }
                            }, "Send Request")
                        )
                    )
                ),

                // Friend Requests
                friendRequests.length > 0 && React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('h3', { className: "text-xl text-calm-800 mb-4", style: { fontWeight: 300 } },
                        `friend requests (${friendRequests.length})`
                    ),
                    React.createElement('div', { className: "space-y-3" },
                        friendRequests.map(request =>
                            React.createElement('div', {
                                key: request.id,
                                className: "p-4 bg-calm-50 rounded-lg border border-calm-200 flex justify-between items-center"
                            },
                                React.createElement('div', null,
                                    React.createElement('p', { className: "text-lg text-calm-800", style: { fontWeight: 400 } },
                                        `@${request.fromUsername}`
                                    ),
                                    React.createElement('p', { className: "text-sm text-calm-600", style: { fontWeight: 300 } },
                                        formatDate(request.createdAt)
                                    )
                                ),
                                React.createElement('div', { className: "flex gap-2" },
                                    React.createElement('button', {
                                        onClick: () => handleAcceptRequest(request),
                                        className: "p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition"
                                    }, React.createElement(CheckIcon)),
                                    React.createElement('button', {
                                        onClick: () => handleDeclineRequest(request),
                                        className: "p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition"
                                    }, React.createElement(XIcon))
                                )
                            )
                        )
                    )
                ),

                // Nous Requests
                nousRequests.length > 0 && React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('h3', { className: "text-xl text-calm-800 mb-4", style: { fontWeight: 300 } },
                        `nous together requests (${nousRequests.length})`
                    ),
                    React.createElement('div', { className: "space-y-3" },
                        nousRequests.map(request =>
                            React.createElement('div', {
                                key: request.id,
                                className: "p-4 bg-purple-50 rounded-lg border border-purple-200 flex justify-between items-center"
                            },
                                React.createElement('div', null,
                                    React.createElement('p', { className: "text-lg text-calm-800", style: { fontWeight: 400 } },
                                        `@${request.fromUsername} wants to Nous together`
                                    ),
                                    React.createElement('p', { className: "text-sm text-calm-600", style: { fontWeight: 300 } },
                                        formatDate(request.createdAt)
                                    )
                                ),
                                React.createElement('div', { className: "flex gap-2" },
                                    React.createElement('button', {
                                        onClick: () => handleAcceptNousRequest(request),
                                        className: "px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm",
                                        style: { fontWeight: 400 }
                                    }, "Accept"),
                                    React.createElement('button', {
                                        onClick: () => handleDeclineNousRequest(request),
                                        className: "px-3 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition text-sm",
                                        style: { fontWeight: 400 }
                                    }, "Decline")
                                )
                            )
                        )
                    )
                ),

                // My Friends List
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('h3', { className: "text-xl text-calm-800 mb-4", style: { fontWeight: 300 } },
                        `my friends (${friends.length})`
                    ),
                    friends.length > 0 ?
                        React.createElement('div', { className: "space-y-3" },
                            friends.map(friend =>
                                React.createElement('div', {
                                    key: friend.friendshipId,
                                    className: "p-4 bg-calm-50 rounded-lg border border-calm-200 hover:border-calm-300 transition"
                                },
                                    React.createElement('div', { className: "flex flex-col gap-3" },
                                        React.createElement('div', { className: "flex justify-between items-start" },
                                            React.createElement('div', { className: "flex-grow" },
                                                React.createElement('p', { className: "text-lg text-calm-800 mb-1", style: { fontWeight: 400 } },
                                                    `@${friend.username}`
                                                ),
                                                React.createElement('div', { className: "flex items-center gap-4 text-sm text-calm-600", style: { fontWeight: 300 } },
                                                    React.createElement('span', null,
                                                        `${friend.stats?.totalHours?.toFixed(1) || 0}h total`
                                                    ),
                                                    friend.stats?.currentStreak > 0 && React.createElement('span', null,
                                                        `${friend.stats.currentStreak} day streak `
                                                    )
                                                ),
                                                // Today's hours and current topic
                                                React.createElement('div', { className: "flex items-center gap-4 text-sm text-calm-700 mt-1", style: { fontWeight: 300 } },
                                                    React.createElement('span', null,
                                                        `Today: ${friend.stats?.hoursToday?.toFixed(1) || 0}h`
                                                    ),
                                                    friend.currentTopic && React.createElement('span', { className: "text-accent-blue", style: { fontWeight: 400, color: '#6B8DD6' } },
                                                        ` ${friend.currentTopic}`
                                                    )
                                                )
                                            ),
                                            React.createElement('button', {
                                                onClick: () => handleUnfriend(friend),
                                                className: "text-sm text-calm-500 hover:text-red-600 transition",
                                                style: { fontWeight: 300 }
                                            }, "Unfriend")
                                        ),
                                        // Nous together button
                                        React.createElement('button', {
                                            onClick: () => handleNousRequest(friend),
                                            className: "px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-xs",
                                            style: { fontWeight: 400 }
                                        }, "Nous together")
                                    )
                                )
                            )
                        ) :
                        React.createElement('p', { className: "text-center text-calm-500 py-8", style: { fontWeight: 300 } },
                            "No friends yet. Add some friends to get started!"
                        )
                )
            );
        };


        // --- Leaderboard Page Component ---
        const Leaderboard = ({ db, userId, setNotification, userProfile }) => {
            const [friendsData, setFriendsData] = useState([]);
            const [selectedMetric, setSelectedMetric] = useState('totalHours');
            const [isLoading, setIsLoading] = useState(true);

            // Load friends and their stats
            useEffect(() => {
                if (!db || !userId) return;

                const fetchLeaderboard = async () => {
                    try {
                        // Get all friendships
                        const friendshipsQuery1 = window.query(
                            window.collection(db, 'friendships'),
                            window.where('user1Id', '==', userId)
                        );
                        const friendshipsQuery2 = window.query(
                            window.collection(db, 'friendships'),
                            window.where('user2Id', '==', userId)
                        );

                        const [snap1, snap2] = await Promise.all([
                            window.getDocs(friendshipsQuery1),
                            window.getDocs(friendshipsQuery2)
                        ]);

                        const allFriendsData = [];

                        // Get stats for each friend
                        for (const doc of [...snap1.docs, ...snap2.docs]) {
                            const data = doc.data();
                            const friendId = data.user1Id === userId ? data.user2Id : data.user1Id;

                            // Fetch friend's profile
                            const friendDocRef = window.doc(db, 'users', friendId);
                            const friendSnapshot = await window.getDoc(friendDocRef);
                            const friendData = friendSnapshot.data();

                            if (friendData && friendData.stats) {
                                allFriendsData.push({
                                    userId: friendId,
                                    username: data.user1Id === userId ? data.user2Username : data.user1Username,
                                    stats: friendData.stats,
                                    isCurrentUser: false
                                });
                            }
                        }

                        // Add current user to leaderboard
                        if (userProfile && userProfile.stats) {
                            allFriendsData.push({
                                userId: userId,
                                username: userProfile.username,
                                stats: userProfile.stats,
                                isCurrentUser: true
                            });
                        }

                        setFriendsData(allFriendsData);
                        setIsLoading(false);
                    } catch (error) {
                        console.error("Error fetching leaderboard:", error);
                        setNotification({ type: 'error', message: 'Failed to load leaderboard: ' + error.message });
                        setIsLoading(false);
                    }
                };

                fetchLeaderboard();
            }, [db, userId, userProfile]);

            // Sort friends by selected metric
            const sortedFriends = [...friendsData].sort((a, b) => {
                const aValue = a.stats?.[selectedMetric] || 0;
                const bValue = b.stats?.[selectedMetric] || 0;
                return bValue - aValue;
            });

            // Get current user's rank
            const currentUserIndex = sortedFriends.findIndex(f => f.isCurrentUser);
            const currentUserRank = currentUserIndex + 1;

            // Get motivational message
            const getMotivationalMessage = () => {
                if (sortedFriends.length === 0) return "Add friends to compete!";
                if (currentUserRank === 1) return "You're leading the pack! ";
                if (currentUserRank === 2) return "So close to #1! Keep going! ";
                if (currentUserRank === 3) return "Great work! Push for the podium! ";

                const nextFriend = sortedFriends[currentUserRank - 2];
                const diff = nextFriend.stats?.[selectedMetric] - (userProfile?.stats?.[selectedMetric] || 0);

                if (selectedMetric === 'totalHours') {
                    return `${diff.toFixed(1)}h to reach #${currentUserRank - 1} `;
                } else if (selectedMetric === 'currentStreak') {
                    return `${Math.ceil(diff)} days to reach #${currentUserRank - 1} `;
                } else if (selectedMetric === 'longestSession') {
                    return `${diff.toFixed(1)}h to reach #${currentUserRank - 1} `;
                } else {
                    return `${Math.ceil(diff)} sessions to reach #${currentUserRank - 1} `;
                }
            };

            // Format metric value
            const formatMetricValue = (value, metric) => {
                if (metric === 'totalHours') {
                    return `${value.toFixed(1)} hours`;
                } else if (metric === 'currentStreak') {
                    return `${Math.floor(value)} day${value !== 1 ? 's' : ''}`;
                } else if (metric === 'longestSession') {
                    return `${value.toFixed(1)} hours`;
                } else {
                    return `${Math.floor(value)} session${value !== 1 ? 's' : ''}`;
                }
            };

            // Get medal emoji
            const getMedal = (rank) => {
                if (rank === 1) return '';
                if (rank === 2) return '';
                if (rank === 3) return '';
                return '';
            };

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading leaderboard...")
                );
            }

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6" },
                // Header
                React.createElement('h2', { className: "text-3xl text-calm-800 mb-2", style: { fontWeight: 300 } }, "leaderboard"),

                // Metric Selector
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    React.createElement('div', { className: "flex flex-wrap gap-2" },
                        [
                            { key: 'totalHours', label: 'Total Hours' },
                            { key: 'currentStreak', label: 'Current Streak' },
                            { key: 'totalSessions', label: 'Total Sessions' },
                            { key: 'longestSession', label: 'Longest Session' }
                        ].map(metric =>
                            React.createElement('button', {
                                key: metric.key,
                                onClick: () => setSelectedMetric(metric.key),
                                className: `px-4 py-2 rounded-lg transition ${
                                    selectedMetric === metric.key
                                        ? 'bg-calm-600 text-white'
                                        : 'bg-calm-100 text-calm-700 hover:bg-calm-200'
                                }`,
                                style: { fontWeight: selectedMetric === metric.key ? 400 : 300 }
                            }, metric.label)
                        )
                    )
                ),

                // Leaderboard List
                React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                    sortedFriends.length > 0 ?
                        React.createElement('div', { className: "space-y-2" },
                            sortedFriends.map((friend, index) => {
                                const rank = index + 1;
                                const medal = getMedal(rank);
                                const value = friend.stats?.[selectedMetric] || 0;

                                return React.createElement('div', {
                                    key: friend.userId,
                                    className: `p-4 rounded-lg border-2 transition ${
                                        friend.isCurrentUser
                                            ? 'bg-blue-50 border-blue-200'
                                            : 'bg-calm-50 border-calm-200 hover:border-calm-300'
                                    }`
                                },
                                    React.createElement('div', { className: "flex justify-between items-center" },
                                        React.createElement('div', { className: "flex items-center gap-3" },
                                            React.createElement('span', {
                                                className: "text-2xl w-8 text-center",
                                                style: { fontWeight: 300 }
                                            }, medal || rank),
                                            React.createElement('div', null,
                                                React.createElement('p', {
                                                    className: `text-lg ${friend.isCurrentUser ? 'text-blue-800' : 'text-calm-800'}`,
                                                    style: { fontWeight: 400 }
                                                }, `@${friend.username}${friend.isCurrentUser ? ' (you)' : ''}`),
                                                React.createElement('p', {
                                                    className: "text-sm text-calm-600",
                                                    style: { fontWeight: 300 }
                                                }, formatMetricValue(value, selectedMetric))
                                            )
                                        ),
                                        friend.isCurrentUser && React.createElement('div', {
                                            className: "px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm",
                                            style: { fontWeight: 400 }
                                        }, `#${rank}`)
                                    )
                                );
                            })
                        ) :
                        React.createElement('p', { className: "text-center text-calm-500 py-8", style: { fontWeight: 300 } },
                            "Add friends to see the leaderboard!"
                        )
                ),

                // User Rank Summary
                sortedFriends.length > 0 && React.createElement('div', { className: "bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl soft-shadow p-6 text-center" },
                    React.createElement('p', { className: "text-2xl text-calm-800 mb-2", style: { fontWeight: 300 } },
                        currentUserRank > 0 ? `Your Rank: #${currentUserRank} of ${sortedFriends.length}` : 'Join the competition!'
                    ),
                    React.createElement('p', { className: "text-calm-600", style: { fontWeight: 300 } },
                        getMotivationalMessage()
                    )
                )
            );
        };
        // --- Main App Component ---
        function App() {
            // These would be provided by the environment (e.g., Netlify build environment variables)
            // For local testing, you would replace these with your actual Firebase config.
            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? __firebase_config 
                : null;
                
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const [firebaseApp, setFirebaseApp] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [notification, setNotification] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [configError, setConfigError] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(window.firebaseSDKReady || false);
            const [showUsernameSetup, setShowUsernameSetup] = useState(false);
            const [newUsername, setNewUsername] = useState('');
            const [usernameError, setUsernameError] = useState('');
            const [isSettingUsername, setIsSettingUsername] = useState(false);

            // Timer state lifted to App level so it persists across page navigation
            const [activeTimers, setActiveTimers] = useState({});
            const timerIntervals = useRef({});

            // Listen for Firebase SDK ready event
            useEffect(() => {
                if (window.firebaseSDKReady) {
                    setFirebaseReady(true);
                } else {
                    const handleFirebaseReady = () => setFirebaseReady(true);
                    window.addEventListener('firebaseReady', handleFirebaseReady, { once: true });
                    return () => window.removeEventListener('firebaseReady', handleFirebaseReady);
                }
            }, []);

            useEffect(() => {
                if (!firebaseReady) return;

                // Validate Firebase config
                if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    const errorMsg = "Firebase configuration is missing required values. Please check your environment variables.";
                    console.error(errorMsg);
                    setConfigError(errorMsg);
                    setIsAuthReady(true);
                    return;
                }

                try {
                    // Check if Firebase app is already initialized to avoid duplicate initialization
                    let app;
                    try {
                        app = window.initializeApp(firebaseConfig);
                    } catch (error) {
                        if (error.code === 'app/duplicate-app' || error.message.includes('already exists')) {
                            app = window.getApp(); // Get the existing app
                        } else {
                            throw error; // Re-throw if it's a different error
                        }
                    }
                    
                    const authInstance = window.getAuth(app);
                    const dbInstance = window.getFirestore(app);
                    
                    setFirebaseApp(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = window.onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUser(user);
                            setUserId(user.uid);
                        } else {
                            // If no user and an initial token exists, try to sign in with it.
                            // This handles the case where the Canvas environment provides a token.
                            if(initialAuthToken) {
                                 try {
                                    await window.signInWithCustomToken(authInstance, initialAuthToken);
                                    // The onAuthStateChanged will re-trigger with the new user.
                                 } catch (error) {
                                     console.error("Custom token sign-in failed, trying anonymous:", error);
                                     await window.signInAnonymously(authInstance); // Fallback to anonymous
                                 }
                            } else {
                                // Otherwise, no user and no token, so clear state.
                                setUser(null);
                                setUserId(null);
                            }
                        }
                        setIsAuthReady(true);
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    setConfigError(`Firebase initialization failed: ${error.message}`);
                    setIsAuthReady(true);
                }
            }, [firebaseReady, JSON.stringify(firebaseConfig), initialAuthToken]); // Effect depends on config values and Firebase SDK being ready

            // User profile initialization
            useEffect(() => {
                if (!db || !userId || !auth) return;

                const userDocRef = window.doc(db, 'users', userId);
                const unsubscribe = window.onSnapshot(userDocRef, async (snapshot) => {
                    if (!snapshot.exists()) {
                        // Create new user profile with unique friend code, but no username yet
                        try {
                            const uniqueCode = await generateUniqueFriendCode(db);
                            await window.setDoc(userDocRef, {
                                username: '', // Empty username - user must set it
                                email: auth.currentUser?.email || '',
                                friendCode: uniqueCode,
                                createdAt: window.Timestamp.now(),
                                settings: {
                                    showStats: true,
                                    showActivity: true,
                                    allowFriendRequests: true
                                },
                                stats: {
                                    totalHours: 0,
                                    currentStreak: 0,
                                    totalSessions: 0,
                                    goalsCompleted: 0,
                                    treeLevel: 0,
                                    lastUpdated: window.Timestamp.now()
                                }
                            });
                            // Show username setup modal for new users
                            setShowUsernameSetup(true);
                        } catch (error) {
                            console.error("Error creating user profile:", error);
                        }
                    } else {
                        const data = snapshot.data();

                        // Check if user needs to set a username
                        if (!data.username || data.username.startsWith('user_') || data.username === '') {
                            setShowUsernameSetup(true);
                            setUserProfile(data);
                        } else {
                            setShowUsernameSetup(false);
                        }

                        // Backfill friend code for existing users who don't have one
                        if (!data.friendCode) {
                            try {
                                const newFriendCode = await generateUniqueFriendCode(db);
                                await window.setDoc(userDocRef, {
                                    friendCode: newFriendCode
                                }, { merge: true });
                                // Update local state with the new friend code
                                setUserProfile({ ...data, friendCode: newFriendCode });
                            } catch (error) {
                                console.error("Error generating friend code:", error);
                                setUserProfile(data);
                            }
                        } else {
                            setUserProfile(data);
                        }
                    }
                });

                return () => unsubscribe();
            }, [db, userId, auth]);

            // Handle username submission
            const handleUsernameSubmit = async (e) => {
                e.preventDefault();
                if (!newUsername.trim()) {
                    setUsernameError('Username cannot be empty');
                    return;
                }

                if (newUsername.length < 3) {
                    setUsernameError('Username must be at least 3 characters');
                    return;
                }

                if (newUsername.length > 20) {
                    setUsernameError('Username must be less than 20 characters');
                    return;
                }

                if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                    setUsernameError('Username can only contain letters, numbers, and underscores');
                    return;
                }

                setIsSettingUsername(true);
                setUsernameError('');

                try {
                    // Check if username is unique
                    const usersQuery = window.query(
                        window.collection(db, 'users'),
                        window.where('username', '==', newUsername.trim())
                    );
                    const snapshot = await window.getDocs(usersQuery);

                    if (!snapshot.empty && snapshot.docs[0].id !== userId) {
                        setUsernameError('Username already taken');
                        setIsSettingUsername(false);
                        return;
                    }

                    // Save username
                    const userDocRef = window.doc(db, 'users', userId);
                    await window.setDoc(userDocRef, {
                        username: newUsername.trim()
                    }, { merge: true });

                    setShowUsernameSetup(false);
                    setNewUsername('');
                    setNotification({ type: 'success', message: `Welcome, @${newUsername}!` });
                } catch (error) {
                    console.error("Error setting username:", error);
                    setUsernameError('Failed to set username. Please try again.');
                } finally {
                    setIsSettingUsername(false);
                }
            };

            // Notification timeout
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            if (configError) {
                return React.createElement('div', { className: "min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4" },
                    React.createElement('div', { className: "max-w-md w-full bg-white p-8 rounded-xl shadow-lg text-center" },
                        React.createElement('h2', { className: "text-2xl text-red-600 mb-4", style: { fontWeight: 400 } }, "Configuration Error"),
                        React.createElement('p', { className: "text-gray-700 mb-4", style: { fontWeight: 300 } }, configError),
                        React.createElement('p', { className: "text-gray-600 text-sm", style: { fontWeight: 300 } }, "Please contact the administrator to fix the configuration.")
                    )
                );
            }

            if (!isAuthReady) {
                return React.createElement('div', { className: "min-h-screen bg-gray-50 flex justify-center items-center" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "text-xl ml-4" }, "Connecting...")
                );
            }

            return React.createElement('div', { className: "min-h-screen font-sans", style: { backgroundColor: '#f8f9fb' } },
                // Username Setup Modal
                showUsernameSetup && React.createElement('div', {
                    className: "fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50",
                    style: { backdropFilter: 'blur(4px)' }
                },
                    React.createElement('div', {
                        className: "bg-white rounded-2xl p-8 max-w-md w-full m-4 soft-shadow-lg",
                        onClick: (e) => e.stopPropagation()
                    },
                        React.createElement('div', { className: "text-center mb-6" },
                            React.createElement('h2', {
                                className: "text-3xl text-calm-800 mb-2",
                                style: { fontWeight: 300 }
                            }, "welcome to nous"),
                            React.createElement('p', {
                                className: "text-calm-600",
                                style: { fontWeight: 300 }
                            }, "choose a unique username to get started")
                        ),
                        React.createElement('form', { onSubmit: handleUsernameSubmit, className: "space-y-4" },
                            React.createElement('div', null,
                                React.createElement('label', {
                                    htmlFor: "username",
                                    className: "block text-sm text-calm-600 mb-2",
                                    style: { fontWeight: 300 }
                                }, "username"),
                                React.createElement('input', {
                                    id: "username",
                                    type: "text",
                                    value: newUsername,
                                    onChange: (e) => {
                                        setNewUsername(e.target.value);
                                        setUsernameError('');
                                    },
                                    placeholder: "your_username",
                                    autoFocus: true,
                                    disabled: isSettingUsername,
                                    className: "w-full px-4 py-3 border-2 border-calm-300 rounded-lg focus:ring-2 focus:ring-calm-500 focus:border-transparent focus:outline-none transition disabled:opacity-50",
                                    style: { fontWeight: 300 }
                                }),
                                usernameError && React.createElement('p', {
                                    className: "text-red-500 text-sm mt-2",
                                    style: { fontWeight: 300 }
                                }, usernameError)
                            ),
                            React.createElement('div', { className: "text-sm text-calm-600 space-y-1", style: { fontWeight: 300 } },
                                React.createElement('p', null, " 3-20 characters"),
                                React.createElement('p', null, " letters, numbers, and underscores only"),
                                React.createElement('p', null, " must be unique")
                            ),
                            userProfile?.friendCode && React.createElement('div', { className: "bg-calm-50 p-4 rounded-lg" },
                                React.createElement('p', {
                                    className: "text-sm text-calm-600 mb-1",
                                    style: { fontWeight: 300 }
                                }, "your friend code:"),
                                React.createElement('p', {
                                    className: "font-mono text-xl text-calm-800",
                                    style: { fontWeight: 400, letterSpacing: '0.1em' }
                                }, userProfile.friendCode)
                            ),
                            React.createElement('button', {
                                type: "submit",
                                disabled: isSettingUsername || !newUsername.trim(),
                                className: "w-full py-3 bg-calm-600 text-white rounded-lg hover:bg-calm-700 transition disabled:opacity-50 flex items-center justify-center gap-2",
                                style: { fontWeight: 400 }
                            },
                                isSettingUsername && React.createElement(LoaderIcon),
                                isSettingUsername ? "creating..." : "continue"
                            )
                        )
                    )
                ),

                notification && React.createElement('div', {
                    className: `fixed top-5 right-5 p-4 rounded-2xl soft-shadow-lg text-white z-50 ${notification.type === 'success' ? 'neuron-pulse' : ''}`,
                    style: {
                        backgroundColor: notification.type === 'success' ? '#6B8DD6' : '#a8b3c7',
                        fontWeight: 300
                    }
                }, notification.message),

                !user ?
                    React.createElement(AuthComponent, { auth, setNotification }) :
                    React.createElement(React.Fragment, null,
                        React.createElement(Header, { setCurrentPage, currentPage }),
                        React.createElement('main', null,
                            currentPage === 'dashboard' && React.createElement(Dashboard, { db, userId, setNotification, activeTimers, setActiveTimers, timerIntervals }),
                            currentPage === 'goals' && React.createElement(Goals, { db, userId, setNotification }),
                            currentPage === 'friends' && React.createElement(Friends, { db, userId, setNotification, userProfile }),
                            currentPage === 'leaderboard' && React.createElement(Leaderboard, { db, userId, setNotification, userProfile }),
                            currentPage === 'reports' && React.createElement(Reports, { db, userId, setNotification }),
                            currentPage === 'about' && React.createElement(About),
                            currentPage === 'settings' && React.createElement(Settings, { auth, userId, db, userProfile, setNotification })
                        )
                    )
            );
        }

        // Render the app (React 18 syntax)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>