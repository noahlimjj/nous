<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nous</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .timer-display {
            font-family: 'Roboto Mono', 'Courier New', monospace;
            font-size: 3rem;
            font-weight: 300;
            color: #1f2937;
            text-align: center;
            user-select: none;
            margin: 20px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .timer-display.running {
            color: #10b981;
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .timer-display.paused {
            color: #f59e0b;
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .timer-display .milliseconds {
            font-size: 1.8rem;
            color: #6b7280;
            margin-left: 8px;
        }
        
        .timer-display.running .milliseconds {
            color: #059669;
        }
        
        .timer-display.paused .milliseconds {
            color: #d97706;
        }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInAnonymously, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            signInWithCustomToken
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            onSnapshot, 
            query, 
            where, 
            setDoc,
            deleteDoc,
            Timestamp,
            getDocs,
            writeBatch
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Make Firebase functions globally available
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;

        // Firebase configuration - Your actual config
        window.__firebase_config = {
            apiKey: "AIzaSyAk5qHtY3Y_988RBWprbKMiiRc63IECsbg",
            authDomain: "study-d2678.firebaseapp.com",
            projectId: "study-d2678",
            storageBucket: "study-d2678.firebasestorage.app",
            messagingSenderId: "531881111589",
            appId: "1:531881111589:web:4f3acc170683d154210fcc",
            measurementId: "G-W95VY7VVSX"
        };

        // App ID for data organization
        window.__app_id = "study-tracker-app";
    </script>
<style>
        .timer-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .timer-circle-bg {
            fill: none;
            stroke: #e6e6e6;
            stroke-width: 12;
        }
        .timer-circle-progress {
            fill: none;
            stroke: #007bff;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'monospace';
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Helper Functions & Icons ---

        // Icon components (using inline SVG for single-file simplicity)
        const PlayIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polygon', { points: "5 3 19 12 5 21 5 3" }));

        const PauseIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "6", y: "4", width: "4", height: "16" }), React.createElement('rect', { x: "14", y: "4", width: "4", height: "16" }));

        const StopIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }));

        const PlusCircleIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('line', { x1: "12", y1: "8", x2: "12", y2: "16" }), React.createElement('line', { x1: "8", y1: "12", x2: "16", y2: "12" }));

        const TrashIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polyline', { points: "3 6 5 6 21 6" }), React.createElement('path', { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement('line', { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement('line', { x1: "14", y1: "11", x2: "14", y2: "17" }));

        const ChartIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M3 3v18h18" }), React.createElement('path', { d: "M18.7 8a6 6 0 0 0-6 0" }), React.createElement('path', { d: "M12.7 14a6 6 0 0 0-6 0" }), React.createElement('path', { d: "m20.7 17.5-8-8" }));

        const HomeIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" }), React.createElement('polyline', { points: "9 22 9 12 15 12 15 22" }));

        const LogOutIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement('polyline', { points: "16 17 21 12 16 7" }), React.createElement('line', { x1: "21", y1: "12", x2: "9", y2: "12" }));

        const LoaderIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: "animate-spin"
        }, React.createElement('line', { x1: "12", y1: "2", x2: "12", y2: "6" }), React.createElement('line', { x1: "12", y1: "18", x2: "12", y2: "22" }), React.createElement('line', { x1: "4.93", y1: "4.93", x2: "7.76", y2: "7.76" }), React.createElement('line', { x1: "16.24", y1: "16.24", x2: "19.07", y2: "19.07" }), React.createElement('line', { x1: "2", y1: "12", x2: "6", y2: "12" }), React.createElement('line', { x1: "18", y1: "12", x2: "22", y2: "12" }), React.createElement('line', { x1: "4.93", y1: "19.07", x2: "7.76", y2: "16.24" }), React.createElement('line', { x1: "16.24", y1: "7.76", x2: "19.07", y2: "4.93" }));

        // Function to format time like Google Timer with milliseconds
        const formatTime = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((totalMilliseconds % 1000) / 10);
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        };

        // Function to format time for display (without milliseconds)
        const formatTimeDisplay = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        // Function to get milliseconds for display
        const getMilliseconds = (totalMilliseconds) => {
            return Math.floor((totalMilliseconds % 1000) / 10);
        };

        // Function to format Firestore Timestamp to a readable date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        };

        // --- Authentication Component ---
        const AuthComponent = ({ auth, setNotification }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                try {
                    if (isSignUp) {
                        await window.createUserWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Signed up successfully! You are now logged in.' });
                    } else {
                        await window.signInWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Logged in successfully!' });
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    setNotification({ type: 'error', message: error.message });
                }
            };
            
            const handleAnonymousSignIn = async () => {
                try {
                    await window.signInAnonymously(auth);
                    setNotification({ type: 'success', message: 'Signed in as a guest. Your data is temporary.' });
                } catch (error) {
                    console.error("Anonymous sign-in error:", error);
                    setNotification({ type: 'error', message: "Could not sign in as a guest." });
                }
            };

            return React.createElement('div', { className: "min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4" },
                React.createElement('div', { className: "max-w-md w-full bg-white rounded-xl shadow-lg p-8 space-y-6" },
                    React.createElement('div', { className: "text-center" },
                        React.createElement('h1', { className: "text-3xl font-bold text-gray-800" }, "Nous"),
                        React.createElement('p', { className: "text-gray-500 mt-2" }, "Log in or sign up to track your progress")
                    ),
                    React.createElement('form', { onSubmit: handleAuthAction, className: "space-y-4" },
                        React.createElement('input', {
                            type: "email",
                            value: email,
                            onChange: (e) => setEmail(e.target.value),
                            placeholder: "Email address",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('input', {
                            type: "password",
                            value: password,
                            onChange: (e) => setPassword(e.target.value),
                            placeholder: "Password (6+ characters)",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('button', {
                            type: "submit",
                            className: "w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition transform hover:scale-105"
                        }, isSignUp ? 'Sign Up' : 'Log In')
                    ),
                    React.createElement('div', { className: "text-center" },
                        React.createElement('button', { onClick: () => setIsSignUp(!isSignUp), className: "text-sm text-blue-600 hover:underline" },
                            isSignUp ? 'Already have an account? Log In' : "Don't have an account? Sign Up"
                        )
                    ),
                    React.createElement('div', { className: "relative flex py-3 items-center" },
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" }),
                        React.createElement('span', { className: "flex-shrink mx-4 text-gray-400" }, "Or"),
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" })
                    ),
                    React.createElement('button', {
                        onClick: handleAnonymousSignIn,
                        className: "w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition"
                    }, "Continue as Guest")
                )
            );
        };

        // --- Main App Components ---

        const Header = ({ auth, userId, setCurrentPage }) => {
            const handleLogout = () => {
                window.signOut(auth);
            };

            return React.createElement('header', { className: "bg-white shadow-md sticky top-0 z-10" },
                React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
                    React.createElement('div', { className: "flex justify-between items-center h-16" },
                        React.createElement('h1', { className: "text-2xl font-bold text-blue-600" }, "Nous"),
                        React.createElement('nav', { className: "flex items-center space-x-4" },
                            React.createElement('button', { onClick: () => setCurrentPage('dashboard'), title: "Dashboard", className: "p-2 rounded-full hover:bg-gray-100 transition" },
                                React.createElement(HomeIcon)
                            ),
                            React.createElement('button', { onClick: () => setCurrentPage('reports'), title: "Monthly Reports", className: "p-2 rounded-full hover:bg-gray-100 transition" },
                                React.createElement(ChartIcon)
                            ),
                            React.createElement('button', { onClick: handleLogout, title: "Logout", className: "p-2 rounded-full hover:bg-gray-100 transition text-red-500" },
                                React.createElement(LogOutIcon)
                            )
                        )
                    ),
                    React.createElement('div', { className: "text-xs text-gray-500 pb-2 truncate" }, `User ID: ${userId}`)
                )
            );
        };

        const ManualEntryModal = ({ db, userId, habit, onClose, setNotification }) => {
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [hours, setHours] = useState('');
            const [minutes, setMinutes] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                const totalMinutes = parseInt(hours || 0) * 60 + parseInt(minutes || 0);
                if (totalMinutes <= 0) {
                    setNotification({ type: 'error', message: 'Duration must be greater than zero.' });
                    return;
                }

                try {
                    const sessionDate = new Date(date);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                    await window.addDoc(sessionsCol, {
                        habitId: habit.id,
                        habitName: habit.name,
                        startTime: window.Timestamp.fromDate(sessionDate),
                        endTime: window.Timestamp.fromDate(new Date(sessionDate.getTime() + totalMinutes * 60000)),
                        duration: totalMinutes * 60, // store in seconds
                    });
                    setNotification({ type: 'success', message: 'Manual session added successfully.' });
                    onClose();
                } catch (error) {
                    console.error("Error adding manual session:", error);
                    setNotification({ type: 'error', message: 'Failed to add manual session.' });
                }
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-20" },
                React.createElement('div', { className: "bg-white rounded-lg p-8 w-full max-w-md m-4" },
                    React.createElement('h2', { className: "text-2xl font-bold mb-4" }, `Add Manual Entry for "${habit.name}"`),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: "date", className: "block text-sm font-medium text-gray-700" }, "Date"),
                            React.createElement('input', {
                                type: "date",
                                id: "date",
                                value: date,
                                onChange: e => setDate(e.target.value),
                                className: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Duration"),
                            React.createElement('div', { className: "flex items-center space-x-2 mt-1" },
                                React.createElement('input', {
                                    type: "number",
                                    value: hours,
                                    onChange: e => setHours(e.target.value),
                                    placeholder: "Hours",
                                    min: "0",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                }),
                                React.createElement('input', {
                                    type: "number",
                                    value: minutes,
                                    onChange: e => setMinutes(e.target.value),
                                    placeholder: "Minutes",
                                    min: "0",
                                    max: "59",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-end space-x-2 pt-4" },
                            React.createElement('button', { type: "button", onClick: onClose, className: "px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" }, "Cancel"),
                            React.createElement('button', { type: "submit", className: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" }, "Save")
                        )
                    )
                )
            );
        };

        const Dashboard = ({ db, userId, setNotification }) => {
            const [habits, setHabits] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [newHabitName, setNewHabitName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [activeTimers, setActiveTimers] = useState({});
            const timerIntervals = useRef({});
            const [modalHabit, setModalHabit] = useState(null);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);

                const unsubscribeHabits = window.onSnapshot(habitsCol, async (snapshot) => {
                    const habitsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // If this is a new user with no habits, create default habits
                    if (habitsData.length === 0) {
                        const defaultHabits = ['Study', 'Code', 'Read', 'Exercise'];
                        try {
                            for (const habitName of defaultHabits) {
                                await window.addDoc(habitsCol, {
                                    name: habitName,
                                    createdAt: window.Timestamp.now(),
                                    isDefault: true
                                });
                            }
                            setNotification({ type: 'success', message: 'Welcome! Default habits created for you.' });
                        } catch (error) {
                            console.error("Error creating default habits:", error);
                            setNotification({ type: 'error', message: 'Failed to create default habits.' });
                        }
                    }
                    
                    setHabits(habitsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching habits:", error);
                    setNotification({ type: 'error', message: "Could not fetch habits." });
                    setIsLoading(false);
                });

                const unsubscribeSessions = window.onSnapshot(sessionsCol, (snapshot) => {
                    const sessionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort sessions by start time, descending
                    sessionsData.sort((a, b) => b.startTime.toMillis() - a.startTime.toMillis());
                    setSessions(sessionsData);
                }, (error) => {
                    console.error("Error fetching sessions:", error);
                    setNotification({ type: 'error', message: "Could not fetch sessions." });
                });

                return () => {
                    unsubscribeHabits();
                    unsubscribeSessions();
                    // Clear all intervals on component unmount
                    Object.values(timerIntervals.current).forEach(clearInterval);
                };
            }, [db, userId, appId, setNotification]);

            const handleAddHabit = async (e) => {
                e.preventDefault();
                if (newHabitName.trim() === '') return;
                try {
                    const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                    await window.addDoc(habitsCol, {
                        name: newHabitName,
                        createdAt: window.Timestamp.now()
                    });
                    setNewHabitName('');
                    setNotification({ type: 'success', message: 'Habit added!' });
                } catch (error) {
                    console.error("Error adding habit:", error);
                    setNotification({ type: 'error', message: 'Failed to add habit.' });
                }
            };

            const handleDeleteHabit = async (habitId) => {
                if (window.confirm("Are you sure you want to delete this habit and all its sessions? This cannot be undone.")) {
                    try {
                        // Use a batch write to delete the habit and all its sessions atomically
                        const batch = window.writeBatch(db);
                        
                        // 1. Delete the habit document
                        const habitDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habitId}`);
                        batch.delete(habitDocRef);
                        
                        // 2. Query and delete all associated sessions
                        const sessionsQuery = window.query(window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`), window.where("habitId", "==", habitId));
                        const sessionsSnapshot = await window.getDocs(sessionsQuery);
                        sessionsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        setNotification({ type: 'success', message: 'Habit and all its sessions deleted.' });
                    } catch (error) {
                        console.error("Error deleting habit:", error);
                        setNotification({ type: 'error', message: 'Failed to delete habit.' });
                    }
                }
            };
            
            const startTimer = useCallback((habitId) => {
                clearInterval(timerIntervals.current[habitId]);
                
                const now = Date.now();
                setActiveTimers(prev => ({
                    ...prev,
                    [habitId]: {
                        startTime: now,
                        lastTick: now,
                        elapsedMilliseconds: prev[habitId]?.elapsedMilliseconds || 0,
                        isPaused: false
                    }
                }));

                timerIntervals.current[habitId] = setInterval(() => {
                    setActiveTimers(prev => {
                        if (!prev[habitId] || prev[habitId].isPaused) {
                            return prev;
                        }
                        const now = Date.now();
                        const delta = now - prev[habitId].lastTick;
                        const newElapsed = prev[habitId].elapsedMilliseconds + delta;
                        return {
                            ...prev,
                            [habitId]: { ...prev[habitId], elapsedMilliseconds: newElapsed, lastTick: now }
                        };
                    });
                }, 10);
            }, []);

            const pauseTimer = useCallback((habitId) => {
                setActiveTimers(prev => ({
                    ...prev,
                    [habitId]: { ...prev[habitId], isPaused: true }
                }));
                clearInterval(timerIntervals.current[habitId]);
            }, []);

            const stopTimer = useCallback(async (habitId, habitName) => {
                clearInterval(timerIntervals.current[habitId]);
                const timerData = activeTimers[habitId];

                if (timerData && timerData.elapsedMilliseconds > 0) {
                    try {
                        const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                        await window.addDoc(sessionsCol, {
                            habitId,
                            habitName,
                            startTime: window.Timestamp.fromMillis(timerData.startTime),
                            endTime: window.Timestamp.now(),
                            duration: Math.round(timerData.elapsedMilliseconds / 1000)
                        });
                        setNotification({ type: 'success', message: `Session for ${habitName} saved.` });
                    } catch(error) {
                        console.error("Error saving session:", error);
                        setNotification({ type: 'error', message: 'Failed to save session.' });
                    }
                }
                
                setActiveTimers(prev => {
                    const newTimers = { ...prev };
                    delete newTimers[habitId];
                    return newTimers;
                });
                delete timerIntervals.current[habitId];

            }, [activeTimers, db, userId, appId, setNotification]);

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading your dashboard...")
                );
            }

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8" },
                modalHabit && React.createElement(ManualEntryModal, { db, userId, habit: modalHabit, onClose: () => setModalHabit(null), setNotification }),
                
                // Left/Main Column: Habits
                React.createElement('div', { className: "lg:col-span-2" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "My Habits"),
                    
                    // Add new habit form
                    React.createElement('form', { onSubmit: handleAddHabit, className: "bg-white p-4 rounded-lg shadow-sm mb-6 flex gap-4" },
                        React.createElement('input', {
                            type: "text",
                            value: newHabitName,
                            onChange: (e) => setNewHabitName(e.target.value),
                            placeholder: "e.g., Morning Run",
                            className: "flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        }),
                        React.createElement('button', { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Add Habit")
                    ),

                    // Habits List
                    React.createElement('div', { className: "space-y-4" },
                        habits.length > 0 ? habits.map(habit => {
                            const timer = activeTimers[habit.id];
                            const isRunning = timer && !timer.isPaused;
                            
                            return React.createElement('div', { key: habit.id, className: "bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" },
                                React.createElement('div', { className: "flex-grow" },
                                    React.createElement('h3', { className: "text-xl font-semibold text-gray-700 mb-4" }, habit.name),
                                    React.createElement('div', { 
                                        className: `timer-display ${isRunning ? 'running' : (timer ? 'paused' : '')}` 
                                    },
                                        React.createElement('span', null, formatTimeDisplay(timer?.elapsedMilliseconds || 0)),
                                        React.createElement('span', { className: "milliseconds" }, 
                                            `.${String(getMilliseconds(timer?.elapsedMilliseconds || 0)).padStart(2, '0')}`
                                        )
                                    )
                                ),
                                React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                                    isRunning ? 
                                        React.createElement('button', { onClick: () => pauseTimer(habit.id), className: "p-3 bg-yellow-100 text-yellow-600 rounded-full hover:bg-yellow-200 transition" },
                                            React.createElement(PauseIcon)
                                        ) :
                                        React.createElement('button', { onClick: () => startTimer(habit.id), className: "p-3 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition" },
                                            React.createElement(PlayIcon)
                                        ),
                                    React.createElement('button', { onClick: () => stopTimer(habit.id, habit.name), disabled: !timer, className: "p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" },
                                        React.createElement(StopIcon)
                                    ),
                                    React.createElement('button', { onClick: () => setModalHabit(habit), className: "p-3 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition" },
                                        React.createElement(PlusCircleIcon)
                                    ),
                                    React.createElement('button', { onClick: () => handleDeleteHabit(habit.id), className: "p-3 bg-gray-100 text-gray-500 rounded-full hover:bg-gray-200 transition" },
                                        React.createElement(TrashIcon)
                                    )
                                )
                            );
                        }) :
                        React.createElement('p', { className: "text-gray-500 text-center py-8" }, "No habits yet. Add one to get started!")
                    )
                ),

                // Right/Side Column: Recent Sessions
                React.createElement('div', { className: "lg:col-span-1" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Recent Sessions"),
                    React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm space-y-3 max-h-[600px] overflow-y-auto" },
                        sessions.length > 0 ? sessions.slice(0, 15).map(session => 
                            React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0" },
                                React.createElement('p', { className: "font-semibold" }, session.habitName),
                                React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                    React.createElement('span', null, formatDate(session.startTime)),
                                    React.createElement('span', null, formatTime(session.duration))
                                )
                            )
                        ) :
                        React.createElement('p', { className: "text-gray-500" }, "No sessions recorded yet.")
                    )
                )
            );
        };

        const Reports = ({ db, userId, setNotification }) => {
            const [reportData, setReportData] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;

                const fetchReportData = async () => {
                    setIsLoading(true);
                    try {
                        const [year, monthNum] = month.split('-').map(Number);
                        const startDate = new Date(year, monthNum - 1, 1);
                        const endDate = new Date(year, monthNum, 0, 23, 59, 59);

                        const sessionsQuery = window.query(
                            window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`),
                            window.where('startTime', '>=', window.Timestamp.fromDate(startDate)),
                            window.where('startTime', '<=', window.Timestamp.fromDate(endDate))
                        );

                        const snapshot = await window.getDocs(sessionsQuery);
                        const monthlySessions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        monthlySessions.sort((a,b) => b.startTime.toMillis() - a.startTime.toMillis());
                        setSessions(monthlySessions);

                        const data = monthlySessions.reduce((acc, session) => {
                            acc[session.habitName] = (acc[session.habitName] || 0) + session.duration;
                            return acc;
                        }, {});
                        
                        const formattedData = Object.entries(data).map(([name, duration]) => ({ name, duration }));
                        setReportData(formattedData);

                    } catch (error) {
                        console.error("Error fetching report data:", error);
                        setNotification({ type: 'error', message: 'Failed to load report data.' });
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchReportData();
            }, [db, userId, month, appId, setNotification]);
            
            const maxDuration = Math.max(...reportData.map(d => d.duration), 0);
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Monthly Report"),
                React.createElement('div', { className: "mb-6" },
                    React.createElement('label', { htmlFor: "month-select", className: "mr-2 font-semibold" }, "Select Month:"),
                    React.createElement('input', {
                        type: "month",
                        id: "month-select",
                        value: month,
                        onChange: e => setMonth(e.target.value),
                        className: "p-2 border border-gray-300 rounded-lg"
                    })
                ),

                isLoading ? 
                    React.createElement('div', { className: "flex justify-center items-center p-8" },
                        React.createElement(LoaderIcon),
                        React.createElement('span', { className: "ml-2" }, "Generating report...")
                    ) :
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-8" },
                        // Chart Section
                        React.createElement('div', { className: "bg-white p-6 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl font-bold mb-4" }, "Habit Totals"),
                            React.createElement('div', { className: "space-y-4" },
                                reportData.length > 0 ? reportData.map((item, index) => 
                                    React.createElement('div', { key: item.name },
                                        React.createElement('div', { className: "flex justify-between mb-1 text-sm font-medium" },
                                            React.createElement('span', null, item.name),
                                            React.createElement('span', null, formatTime(item.duration))
                                        ),
                                        React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-4" },
                                            React.createElement('div', {
                                                className: `${colors[index % colors.length]} h-4 rounded-full`,
                                                style: { width: `${maxDuration > 0 ? (item.duration / maxDuration) * 100 : 0}%` }
                                            })
                                        )
                                    )
                                ) : React.createElement('p', null, "No data for this month.")
                            )
                        ),

                        // Sessions List
                        React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl font-bold mb-4" }, "Session Log"),
                            React.createElement('div', { className: "space-y-3 max-h-[400px] overflow-y-auto" },
                                sessions.length > 0 ? sessions.map(session => 
                                    React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0" },
                                        React.createElement('p', { className: "font-semibold" }, session.habitName),
                                        React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                            React.createElement('span', null, formatDate(session.startTime)),
                                            React.createElement('span', null, formatTime(session.duration))
                                        )
                                    )
                                ) :
                                React.createElement('p', { className: "text-gray-500" }, "No sessions recorded this month.")
                            )
                        )
                    )
            );
        };

        // --- Main App Component ---
        function App() {
            // These would be provided by the environment (e.g., Netlify build environment variables)
            // For local testing, you would replace these with your actual Firebase config.
            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? __firebase_config 
                : { /* YOUR FIREBASE CONFIG HERE FOR LOCAL TESTING */ };
                
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const [firebaseApp, setFirebaseApp] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    const app = window.initializeApp(firebaseConfig);
                    const authInstance = window.getAuth(app);
                    const dbInstance = window.getFirestore(app);
                    
                    setFirebaseApp(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = window.onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUser(user);
                            setUserId(user.uid);
                        } else {
                            // If no user and an initial token exists, try to sign in with it.
                            // This handles the case where the Canvas environment provides a token.
                            if(initialAuthToken) {
                                 try {
                                    await window.signInWithCustomToken(authInstance, initialAuthToken);
                                    // The onAuthStateChanged will re-trigger with the new user.
                                 } catch (error) {
                                     console.error("Custom token sign-in failed, trying anonymous:", error);
                                     await window.signInAnonymously(authInstance); // Fallback to anonymous
                                 }
                            } else {
                                // Otherwise, no user and no token, so clear state.
                                setUser(null);
                                setUserId(null);
                            }
                        }
                        setIsAuthReady(true);
                    });
                    return () => unsubscribe();
                } else {
                    console.error("Firebase config is not available.");
                    setIsAuthReady(true); // Allow UI to render with an error or login state
                }
            }, [JSON.stringify(firebaseConfig), initialAuthToken]); // Effect depends on config values
            
            // Notification timeout
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            if (!isAuthReady) {
                return React.createElement('div', { className: "min-h-screen bg-gray-50 flex justify-center items-center" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "text-xl ml-4" }, "Connecting...")
                );
            }

            return React.createElement('div', { className: "bg-gray-50 min-h-screen font-sans" },
                notification && React.createElement('div', { 
                    className: `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 ${notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`
                }, notification.message),
                
                !user ? 
                    React.createElement(AuthComponent, { auth, setNotification }) :
                    React.createElement(React.Fragment, null,
                        React.createElement(Header, { auth, userId, setCurrentPage }),
                        React.createElement('main', null,
                            currentPage === 'dashboard' && React.createElement(Dashboard, { db, userId, setNotification }),
                            currentPage === 'reports' && React.createElement(Reports, { db, userId, setNotification })
                        )
                    )
            );
        }

        // Render the app
        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>
</html>