<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nous</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="A modern study habit tracker and time management app">
    <meta name="theme-color" content="#5d6b86">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Nous">
    <link rel="manifest" href="/manifest.json">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-192x192.png">

    <!-- Favicon - Properly Centered -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cstyle%3Etext%7Bfont-family:Inter,-apple-system,sans-serif;font-weight:300;font-size:72px;fill:%235d6b86;text-anchor:middle;dominant-baseline:central%7D%3C/style%3E%3Ccircle cx='50' cy='50' r='35' fill='none' stroke='%235d6b86' stroke-width='3'/%3E%3Ctext x='50' y='45.7' letter-spacing='1.5'%3En%3C/text%3E%3C/svg%3E">

    <!-- Resource Hints for Performance -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://api.fontshare.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://api.fontshare.com">

    <!-- Satoshi font -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="gamification.css">

    <!-- Firebase Configuration - Must load first -->
    <script src="config.js?v=16&t=1730700000"></script>

    <!-- Offline Mode Handler - Suppress Firebase errors when offline -->
    <script src="offline-handler.js"></script>

    <!-- Offline Timer Manager - Handle timer operations offline and sync when back online -->
    <script src="offline-timer-manager.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInWithPopup,
            GoogleAuthProvider,
            setPersistence,
            browserLocalPersistence
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            initializeFirestore,
            persistentLocalCache,
            persistentMultipleTabManager,
            collection,
            addDoc,
            doc,
            getDoc,
            onSnapshot,
            query,
            where,
            setDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            getDocs,
            writeBatch,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import {
            getFunctions,
            httpsCallable
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Make Firebase functions globally available
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInWithPopup = signInWithPopup;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.setPersistence = setPersistence;
        window.browserLocalPersistence = browserLocalPersistence;
        window.getFirestore = getFirestore;
        window.initializeFirestore = initializeFirestore;
        window.persistentLocalCache = persistentLocalCache;
        window.persistentMultipleTabManager = persistentMultipleTabManager;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;
        window.serverTimestamp = serverTimestamp;
        window.getFunctions = getFunctions;
        window.httpsCallable = httpsCallable;

        // Signal that Firebase SDK is ready
        window.firebaseSDKReady = true;
        window.dispatchEvent(new Event('firebaseReady'));

        // Firebase configuration is loaded from config.js
        // If config.js is not found, the app will show an error
    </script>
</head>

<body>
    <!-- PWA Service Worker Registration - v19 -->
    <script>
        // --- NUCLEAR CACHE CLEARING ---
        // Force unregister old service workers to ensure immediate update
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    if (registration.active && registration.active.scriptURL.includes('v23')) {
                        console.log('Force unregistering old v23 SW');
                        registration.unregister();
                    }
                }
            });
        }
    </script>
    <script>
        // Smart service worker registration with improved error handling
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                const CURRENT_SW = '/service-worker-v25.js';
                const CURRENT_CACHE_PREFIX = 'nous-v25';

                try {
                    console.log('[PWA] Initializing service worker...');

                    // Check existing registrations
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    let hasCurrentVersion = false;

                    for (const reg of registrations) {
                        const scriptURL = reg.active?.scriptURL || '';
                        if (scriptURL.includes('service-worker-v23.js')) {
                            hasCurrentVersion = true;
                            console.log('[PWA] ✓ Service worker v23 already registered');
                        } else {
                            // Unregister old versions
                            console.log('[PWA] Unregistering old SW:', scriptURL);
                            await reg.unregister();
                        }
                    }

                    // Clear old caches
                    const cacheNames = await caches.keys();
                    for (const name of cacheNames) {
                        if (!name.includes(CURRENT_CACHE_PREFIX)) {
                            console.log('[PWA] Deleting old cache:', name);
                            await caches.delete(name);
                        }
                    }

                    // Register current version if not already registered
                    if (!hasCurrentVersion) {
                        console.log('[PWA] Registering service worker v23...');
                        const registration = await navigator.serviceWorker.register(CURRENT_SW, {
                            scope: '/'
                        });

                        // Wait for registration to complete
                        if (registration.installing) {
                            console.log('[PWA] Installing service worker...');
                            await new Promise((resolve) => {
                                registration.installing.addEventListener('statechange', (e) => {
                                    if (e.target.state === 'activated') {
                                        resolve();
                                    }
                                });
                            });
                        }

                        console.log('[PWA] ✓ Service worker v23 registered successfully');

                        // Check for updates every 5 minutes
                        setInterval(() => {
                            console.log('[PWA] Checking for updates...');
                            registration.update();
                        }, 5 * 60 * 1000);

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New version available! Reload to update.');
                                }
                            });
                        });
                    }

                    // Log cache status
                    const cache = await caches.open(CURRENT_CACHE_PREFIX);
                    const cachedRequests = await cache.keys();
                    console.log(`[PWA] ✓ Cache ready with ${cachedRequests.length} files`);

                } catch (error) {
                    console.error('[PWA] Service worker registration failed:', error);
                    console.log('[PWA] App will continue without offline support');
                    // App continues to work without service worker
                }
            });
        } else {
            console.warn('[PWA] Service workers not supported in this browser');
        }
    </script>

    <div id="root"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>

    <script src="HabitsTab.js?v=49"></script>
    <script src="components/CalendarChecklist.js"></script>
    <script src="index.js?v=28&t=1766656000"></script>

</body>

</html>