<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nous</title>

    <!-- Satoshi font -->
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@300,400,500,700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                        'title': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
                        'body': ['"Satoshi"', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        'calm': {
                            50: '#f8f9fb',
                            100: '#f1f3f7',
                            200: '#e4e8ee',
                            300: '#d1d7e3',
                            400: '#a8b3c7',
                            500: '#7d8ca8',
                            600: '#5d6b86',
                            700: '#4a5568',
                            800: '#363f51',
                            900: '#252d3d',
                        },
                        'accent': {
                            blue: '#6B8DD6',
                            purple: '#8B7FB8',
                            teal: '#5FA8A3',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Set default body font */
        body {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 400;
            background-color: #f8f9fb;
        }

        /* Title styling with letter spacing */
        .nous-title {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 300;
            letter-spacing: 0.025em; /* 2.5% letter spacing */
        }

        /* Light weight for headers */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 300;
        }

        /* Soft shadows */
        .soft-shadow {
            box-shadow: 0 2px 12px rgba(99, 110, 129, 0.08), 0 1px 4px rgba(99, 110, 129, 0.04);
        }

        .soft-shadow-lg {
            box-shadow: 0 8px 24px rgba(99, 110, 129, 0.12), 0 2px 8px rgba(99, 110, 129, 0.06);
        }

        /* Pulse animation for success */
        @keyframes neuron-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .neuron-pulse {
            animation: neuron-pulse 1.5s ease-in-out;
        }

        /* Glow effect for streaks */
        @keyframes soft-glow {
            0%, 100% {
                box-shadow: 0 0 8px rgba(107, 141, 214, 0.3), 0 0 16px rgba(107, 141, 214, 0.1);
            }
            50% {
                box-shadow: 0 0 12px rgba(107, 141, 214, 0.5), 0 0 24px rgba(107, 141, 214, 0.2);
            }
        }

        .soft-glow {
            animation: soft-glow 2s ease-in-out infinite;
        }

        /* Circular logo animation */
        @keyframes circle-flow {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -200;
            }
        }

        .circle-flow {
            stroke-dasharray: 100;
            animation: circle-flow 8s linear infinite;
        }
        .timer-display {
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 3rem;
            font-weight: 300;
            font-variant-numeric: tabular-nums;
            color: #1f2937;
            text-align: center;
            user-select: none;
            margin: 20px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .timer-display.running {
            color: #10b981;
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        .timer-display.paused {
            color: #f59e0b;
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .timer-display .milliseconds {
            font-size: 1.8rem;
            color: #6b7280;
            margin-left: 8px;
        }
        
        .timer-display.running .milliseconds {
            color: #059669;
        }
        
        .timer-display.paused .milliseconds {
            color: #d97706;
        }
    </style>
    <!-- Firebase Configuration - Must load first -->
    <script src="config.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken,
            signInWithPopup,
            GoogleAuthProvider
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            onSnapshot, 
            query, 
            where, 
            setDoc,
            deleteDoc,
            Timestamp,
            getDocs,
            writeBatch
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Make Firebase functions globally available
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInWithPopup = signInWithPopup;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.Timestamp = Timestamp;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;

        // Firebase configuration is loaded from config.js
        // If config.js is not found, the app will show an error
    </script>
<style>
        .timer-container {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .timer-circle-bg {
            fill: none;
            stroke: #e6e6e6;
            stroke-width: 12;
        }
        .timer-circle-progress {
            fill: none;
            stroke: #007bff;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: "Satoshi", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 1.5rem;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Helper Functions & Icons ---

        // Icon components (using inline SVG for single-file simplicity)
        const PlayIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polygon', { points: "5 3 19 12 5 21 5 3" }));

        const PauseIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "6", y: "4", width: "4", height: "16" }), React.createElement('rect', { x: "14", y: "4", width: "4", height: "16" }));

        const StopIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('rect', { x: "3", y: "3", width: "18", height: "18", rx: "2", ry: "2" }));

        const PlusCircleIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "10" }), React.createElement('line', { x1: "12", y1: "8", x2: "12", y2: "16" }), React.createElement('line', { x1: "8", y1: "12", x2: "16", y2: "12" }));

        const TrashIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('polyline', { points: "3 6 5 6 21 6" }), React.createElement('path', { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" }), React.createElement('line', { x1: "10", y1: "11", x2: "10", y2: "17" }), React.createElement('line', { x1: "14", y1: "11", x2: "14", y2: "17" }));

        const ChartIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M3 3v18h18" }), React.createElement('path', { d: "M18.7 8a6 6 0 0 0-6 0" }), React.createElement('path', { d: "M12.7 14a6 6 0 0 0-6 0" }), React.createElement('path', { d: "m20.7 17.5-8-8" }));

        const HomeIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" }), React.createElement('polyline', { points: "9 22 9 12 15 12 15 22" }));

        const LogOutIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" }), React.createElement('polyline', { points: "16 17 21 12 16 7" }), React.createElement('line', { x1: "21", y1: "12", x2: "9", y2: "12" }));

        const LoaderIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: "animate-spin"
        }, React.createElement('line', { x1: "12", y1: "2", x2: "12", y2: "6" }), React.createElement('line', { x1: "12", y1: "18", x2: "12", y2: "22" }), React.createElement('line', { x1: "4.93", y1: "4.93", x2: "7.76", y2: "7.76" }), React.createElement('line', { x1: "16.24", y1: "16.24", x2: "19.07", y2: "19.07" }), React.createElement('line', { x1: "2", y1: "12", x2: "6", y2: "12" }), React.createElement('line', { x1: "18", y1: "12", x2: "22", y2: "12" }), React.createElement('line', { x1: "4.93", y1: "19.07", x2: "7.76", y2: "16.24" }), React.createElement('line', { x1: "16.24", y1: "7.76", x2: "19.07", y2: "4.93" }));

        const GoogleIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "20",
            height: "20",
            viewBox: "0 0 48 48"
        },
            React.createElement('path', { fill: "#FFC107", d: "M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" }),
            React.createElement('path', { fill: "#FF3D00", d: "M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" }),
            React.createElement('path', { fill: "#4CAF50", d: "M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" }),
            React.createElement('path', { fill: "#1976D2", d: "M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z" })
        );

        const SettingsIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('circle', { cx: "12", cy: "12", r: "3" }), React.createElement('path', { d: "M12 1v6m0 6v6m-6-6h6m6 0h6" }));

        const NotebookIcon = () => React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: "24",
            height: "24",
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round"
        }, React.createElement('path', { d: "M4 19.5A2.5 2.5 0 0 1 6.5 17H20" }), React.createElement('path', { d: "M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" }));

        // Logo component with circular flow around 'n'
        const NousLogo = ({ size = "medium" }) => {
            const sizes = {
                small: { width: 70, fontSize: "1.5rem" },
                medium: { width: 100, fontSize: "2.25rem" },
                large: { width: 140, fontSize: "3rem" }
            };
            const { width, fontSize } = sizes[size];

            return React.createElement('div', {
                className: "flex items-center gap-2",
                style: { position: 'relative' }
            },
                // SVG circular flow
                React.createElement('svg', {
                    width: width,
                    height: width * 0.5,
                    viewBox: "0 0 100 50",
                    style: { position: 'absolute', left: -8, top: '50%', transform: 'translateY(-50%)', zIndex: 0, opacity: 0.6 }
                },
                    React.createElement('circle', {
                        cx: "20",
                        cy: "25",
                        r: "18",
                        fill: "none",
                        stroke: "#6B8DD6",
                        strokeWidth: "1.5",
                        className: "circle-flow",
                        opacity: "0.4"
                    })
                ),
                // Text
                React.createElement('span', {
                    className: "nous-title",
                    style: {
                        fontSize,
                        color: '#5d6b86',
                        position: 'relative',
                        zIndex: 1
                    }
                }, "nous")
            );
        };

        // Function to format time like Google Timer with milliseconds
        const formatTime = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((totalMilliseconds % 1000) / 10);
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
        };

        // Function to format time for display (without milliseconds)
        const formatTimeDisplay = (totalMilliseconds) => {
            const totalSeconds = Math.floor(totalMilliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        // Function to get milliseconds for display
        const getMilliseconds = (totalMilliseconds) => {
            return Math.floor((totalMilliseconds % 1000) / 10);
        };

        // Function to format Firestore Timestamp to a readable date
        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        };

        // --- Authentication Component ---
        const AuthComponent = ({ auth, setNotification }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                try {
                    if (isSignUp) {
                        await window.createUserWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Signed up successfully! You are now logged in.' });
                    } else {
                        await window.signInWithEmailAndPassword(auth, email, password);
                        setNotification({ type: 'success', message: 'Logged in successfully!' });
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    setNotification({ type: 'error', message: error.message });
                }
            };
            
            const handleAnonymousSignIn = async () => {
                try {
                    await window.signInAnonymously(auth);
                    setNotification({ type: 'success', message: 'Signed in as a guest. Your data is temporary.' });
                } catch (error) {
                    console.error("Anonymous sign-in error:", error);
                    setNotification({ type: 'error', message: "Could not sign in as a guest." });
                }
            };

            const handleGoogleSignIn = async () => {
                try {
                    const provider = new window.GoogleAuthProvider();
                    await window.signInWithPopup(auth, provider);
                    setNotification({ type: 'success', message: 'Signed in with Google successfully!' });
                } catch (error) {
                    console.error("Google sign-in error:", error);
                    setNotification({ type: 'error', message: error.message });
                }
            };

            return React.createElement('div', { className: "min-h-screen flex flex-col justify-center items-center p-4", style: { backgroundColor: '#f8f9fb' } },
                React.createElement('div', { className: "max-w-md w-full bg-white soft-shadow-lg p-8 space-y-6", style: { borderRadius: '20px' } },
                    React.createElement('div', { className: "flex flex-col items-center" },
                        React.createElement(NousLogo, { size: "large" }),
                        React.createElement('p', { className: "text-calm-600 mt-4", style: { fontWeight: 300 } }, "log in or sign up to track your progress")
                    ),
                    React.createElement('form', { onSubmit: handleAuthAction, className: "space-y-4" },
                        React.createElement('input', {
                            type: "email",
                            value: email,
                            onChange: (e) => setEmail(e.target.value),
                            placeholder: "Email address",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('input', {
                            type: "password",
                            value: password,
                            onChange: (e) => setPassword(e.target.value),
                            placeholder: "Password (6+ characters)",
                            required: true,
                            className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                        }),
                        React.createElement('button', {
                            type: "submit",
                            className: "w-full text-white py-3 px-4 rounded-xl soft-shadow hover:opacity-90 focus:outline-none transition",
                            style: { backgroundColor: '#6B8DD6', fontWeight: 400 }
                        }, isSignUp ? 'sign up' : 'log in')
                    ),
                    React.createElement('div', { className: "text-center" },
                        React.createElement('button', { onClick: () => setIsSignUp(!isSignUp), className: "text-sm text-blue-600 hover:underline" },
                            isSignUp ? 'Already have an account? Log In' : "Don't have an account? Sign Up"
                        )
                    ),
                    React.createElement('div', { className: "relative flex py-3 items-center" },
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" }),
                        React.createElement('span', { className: "flex-shrink mx-4 text-gray-400" }, "Or"),
                        React.createElement('div', { className: "flex-grow border-t border-gray-300" })
                    ),
                    React.createElement('button', {
                        onClick: handleGoogleSignIn,
                        className: "w-full bg-white soft-shadow text-calm-700 py-3 px-4 rounded-xl hover:bg-calm-50 focus:outline-none transition flex items-center justify-center gap-3",
                        style: { fontWeight: 400 }
                    },
                        React.createElement(GoogleIcon),
                        "continue with Google"
                    ),
                    React.createElement('button', {
                        onClick: handleAnonymousSignIn,
                        className: "w-full bg-calm-100 text-calm-700 py-3 px-4 rounded-xl hover:bg-calm-200 focus:outline-none transition",
                        style: { fontWeight: 400 }
                    }, "continue as guest")
                )
            );
        };

        // --- Main App Components ---

        const Header = ({ setCurrentPage, currentPage }) => {
            return React.createElement('header', { className: "bg-white sticky top-0 z-10 soft-shadow" },
                React.createElement('div', { className: "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" },
                    React.createElement('div', { className: "flex justify-between items-center h-16" },
                        React.createElement(NousLogo, { size: "medium" }),
                        React.createElement('nav', { className: "flex items-center space-x-2" },
                            React.createElement('button', {
                                onClick: () => setCurrentPage('dashboard'),
                                title: "Dashboard",
                                className: `p-2 rounded-full transition ${currentPage === 'dashboard' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'dashboard' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(HomeIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('goals'),
                                title: "Goals",
                                className: `p-2 rounded-full transition ${currentPage === 'goals' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'goals' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(NotebookIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('reports'),
                                title: "Monthly Reports",
                                className: `p-2 rounded-full transition ${currentPage === 'reports' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'reports' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(ChartIcon)
                            ),
                            React.createElement('button', {
                                onClick: () => setCurrentPage('settings'),
                                title: "Settings",
                                className: `p-2 rounded-full transition ${currentPage === 'settings' ? 'bg-calm-100 text-accent-blue' : 'text-calm-600 hover:bg-calm-50'}`,
                                style: { color: currentPage === 'settings' ? '#6B8DD6' : '#7d8ca8' }
                            },
                                React.createElement(SettingsIcon)
                            )
                        )
                    )
                )
            );
        };

        const ManualEntryModal = ({ db, userId, habit, onClose, setNotification }) => {
            const [date, setDate] = useState(new Date().toISOString().slice(0, 10));
            const [hours, setHours] = useState('');
            const [minutes, setMinutes] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                const totalMinutes = parseInt(hours || 0) * 60 + parseInt(minutes || 0);
                if (totalMinutes <= 0) {
                    setNotification({ type: 'error', message: 'Duration must be greater than zero.' });
                    return;
                }

                try {
                    const sessionDate = new Date(date);
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                    await window.addDoc(sessionsCol, {
                        habitId: habit.id,
                        habitName: habit.name,
                        startTime: window.Timestamp.fromDate(sessionDate),
                        endTime: window.Timestamp.fromDate(new Date(sessionDate.getTime() + totalMinutes * 60000)),
                        duration: totalMinutes * 60 * 1000, // store in milliseconds
                    });
                    setNotification({ type: 'success', message: 'Manual session added successfully.' });
                    onClose();
                } catch (error) {
                    console.error("Error adding manual session:", error);
                    setNotification({ type: 'error', message: 'Failed to add manual session.' });
                }
            };

            return React.createElement('div', { className: "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-20" },
                React.createElement('div', { className: "bg-white rounded-lg p-8 w-full max-w-md m-4" },
                    React.createElement('h2', { className: "text-2xl font-bold mb-4" }, `Add Manual Entry for "${habit.name}"`),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', null,
                            React.createElement('label', { htmlFor: "date", className: "block text-sm font-medium text-gray-700" }, "Date"),
                            React.createElement('input', {
                                type: "date",
                                id: "date",
                                value: date,
                                onChange: e => setDate(e.target.value),
                                className: "mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            })
                        ),
                        React.createElement('div', null,
                            React.createElement('label', { className: "block text-sm font-medium text-gray-700" }, "Duration"),
                            React.createElement('div', { className: "flex items-center space-x-2 mt-1" },
                                React.createElement('input', {
                                    type: "number",
                                    value: hours,
                                    onChange: e => setHours(e.target.value),
                                    placeholder: "Hours",
                                    min: "0",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                }),
                                React.createElement('input', {
                                    type: "number",
                                    value: minutes,
                                    onChange: e => setMinutes(e.target.value),
                                    placeholder: "Minutes",
                                    min: "0",
                                    max: "59",
                                    className: "block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-end space-x-2 pt-4" },
                            React.createElement('button', { type: "button", onClick: onClose, className: "px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300" }, "Cancel"),
                            React.createElement('button', { type: "submit", className: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700" }, "Save")
                        )
                    )
                )
            );
        };

        const Dashboard = ({ db, userId, setNotification }) => {
            const [habits, setHabits] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [newHabitName, setNewHabitName] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [activeTimers, setActiveTimers] = useState({});
            const timerIntervals = useRef({});
            const [modalHabit, setModalHabit] = useState(null);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);

                const unsubscribeHabits = window.onSnapshot(habitsCol, async (snapshot) => {
                    const habitsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // If this is a new user with no habits, create default habits
                    if (habitsData.length === 0) {
                        const defaultHabits = ['Study', 'Exercise'];
                        try {
                            for (const habitName of defaultHabits) {
                                await window.addDoc(habitsCol, {
                                    name: habitName,
                                    createdAt: window.Timestamp.now(),
                                    isDefault: true
                                });
                            }
                            setNotification({ type: 'success', message: 'Welcome! Default habits created for you.' });
                        } catch (error) {
                            console.error("Error creating default habits:", error);
                            setNotification({ type: 'error', message: 'Failed to create default habits.' });
                        }
                    }
                    
                    setHabits(habitsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching habits:", error);
                    setNotification({ type: 'error', message: "Could not fetch habits." });
                    setIsLoading(false);
                });

                const unsubscribeSessions = window.onSnapshot(sessionsCol, (snapshot) => {
                    const sessionsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort sessions by start time, descending
                    sessionsData.sort((a, b) => b.startTime.toMillis() - a.startTime.toMillis());
                    setSessions(sessionsData);
                }, (error) => {
                    console.error("Error fetching sessions:", error);
                    setNotification({ type: 'error', message: "Could not fetch sessions." });
                });

                return () => {
                    unsubscribeHabits();
                    unsubscribeSessions();
                    // Clear all intervals on component unmount
                    Object.values(timerIntervals.current).forEach(clearInterval);
                };
            }, [db, userId, appId, setNotification]);

            const handleAddHabit = async (e) => {
                e.preventDefault();
                if (newHabitName.trim() === '') return;
                try {
                    const habitsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/habits`);
                    await window.addDoc(habitsCol, {
                        name: newHabitName,
                        createdAt: window.Timestamp.now()
                    });
                    setNewHabitName('');
                    setNotification({ type: 'success', message: 'Habit added!' });
                } catch (error) {
                    console.error("Error adding habit:", error);
                    setNotification({ type: 'error', message: 'Failed to add habit.' });
                }
            };

            const handleDeleteHabit = async (habitId) => {
                if (window.confirm("Are you sure you want to delete this habit and all its sessions? This cannot be undone.")) {
                    try {
                        // Use a batch write to delete the habit and all its sessions atomically
                        const batch = window.writeBatch(db);
                        
                        // 1. Delete the habit document
                        const habitDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/habits/${habitId}`);
                        batch.delete(habitDocRef);
                        
                        // 2. Query and delete all associated sessions
                        const sessionsQuery = window.query(window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`), window.where("habitId", "==", habitId));
                        const sessionsSnapshot = await window.getDocs(sessionsQuery);
                        sessionsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        setNotification({ type: 'success', message: 'Habit and all its sessions deleted.' });
                    } catch (error) {
                        console.error("Error deleting habit:", error);
                        setNotification({ type: 'error', message: 'Failed to delete habit.' });
                    }
                }
            };
            
            const startTimer = useCallback((habitId) => {
                clearInterval(timerIntervals.current[habitId]);
                
                const now = Date.now();
                setActiveTimers(prev => ({
                    ...prev,
                    [habitId]: {
                        startTime: now,
                        lastTick: now,
                        elapsedMilliseconds: prev[habitId]?.elapsedMilliseconds || 0,
                        isPaused: false
                    }
                }));

                timerIntervals.current[habitId] = setInterval(() => {
                    setActiveTimers(prev => {
                        if (!prev[habitId] || prev[habitId].isPaused) {
                            return prev;
                        }
                        const now = Date.now();
                        const delta = now - prev[habitId].lastTick;
                        const newElapsed = prev[habitId].elapsedMilliseconds + delta;
                        return {
                            ...prev,
                            [habitId]: { ...prev[habitId], elapsedMilliseconds: newElapsed, lastTick: now }
                        };
                    });
                }, 10);
            }, []);

            const pauseTimer = useCallback((habitId) => {
                setActiveTimers(prev => ({
                    ...prev,
                    [habitId]: { ...prev[habitId], isPaused: true }
                }));
                clearInterval(timerIntervals.current[habitId]);
            }, []);

            const stopTimer = useCallback(async (habitId, habitName) => {
                clearInterval(timerIntervals.current[habitId]);
                const timerData = activeTimers[habitId];

                if (timerData && timerData.elapsedMilliseconds > 0) {
                    try {
                        const sessionsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`);
                        await window.addDoc(sessionsCol, {
                            habitId,
                            habitName,
                            startTime: window.Timestamp.fromMillis(timerData.startTime),
                            endTime: window.Timestamp.now(),
                            duration: Math.round(timerData.elapsedMilliseconds) // Store in milliseconds
                        });
                        setNotification({ type: 'success', message: `Session for ${habitName} saved.` });
                    } catch(error) {
                        console.error("Error saving session:", error);
                        setNotification({ type: 'error', message: 'Failed to save session.' });
                    }
                }
                
                setActiveTimers(prev => {
                    const newTimers = { ...prev };
                    delete newTimers[habitId];
                    return newTimers;
                });
                delete timerIntervals.current[habitId];

            }, [activeTimers, db, userId, appId, setNotification]);

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading your dashboard...")
                );
            }

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8" },
                modalHabit && React.createElement(ManualEntryModal, { db, userId, habit: modalHabit, onClose: () => setModalHabit(null), setNotification }),
                
                // Left/Main Column: Habits
                React.createElement('div', { className: "lg:col-span-2" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "My Habits"),
                    
                    // Add new habit form
                    React.createElement('form', { onSubmit: handleAddHabit, className: "bg-white p-4 rounded-lg shadow-sm mb-6 flex gap-4" },
                        React.createElement('input', {
                            type: "text",
                            value: newHabitName,
                            onChange: (e) => setNewHabitName(e.target.value),
                            placeholder: "e.g., Morning Run",
                            className: "flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        }),
                        React.createElement('button', { type: "submit", className: "bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition" }, "Add Habit")
                    ),

                    // Habits List
                    React.createElement('div', { className: "space-y-4" },
                        habits.length > 0 ? habits.map(habit => {
                            const timer = activeTimers[habit.id];
                            const isRunning = timer && !timer.isPaused;
                            
                            return React.createElement('div', { key: habit.id, className: "bg-white p-4 rounded-lg shadow-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4" },
                                React.createElement('div', { className: "flex-grow" },
                                    React.createElement('h3', { className: "text-xl font-semibold text-gray-700 mb-4" }, habit.name),
                                    React.createElement('div', { 
                                        className: `timer-display ${isRunning ? 'running' : (timer ? 'paused' : '')}` 
                                    },
                                        React.createElement('span', null, formatTimeDisplay(timer?.elapsedMilliseconds || 0)),
                                        React.createElement('span', { className: "milliseconds" }, 
                                            `.${String(getMilliseconds(timer?.elapsedMilliseconds || 0)).padStart(2, '0')}`
                                        )
                                    )
                                ),
                                React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                                    isRunning ? 
                                        React.createElement('button', { onClick: () => pauseTimer(habit.id), className: "p-3 bg-yellow-100 text-yellow-600 rounded-full hover:bg-yellow-200 transition" },
                                            React.createElement(PauseIcon)
                                        ) :
                                        React.createElement('button', { onClick: () => startTimer(habit.id), className: "p-3 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition" },
                                            React.createElement(PlayIcon)
                                        ),
                                    React.createElement('button', { onClick: () => stopTimer(habit.id, habit.name), disabled: !timer, className: "p-3 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition disabled:opacity-50 disabled:cursor-not-allowed" },
                                        React.createElement(StopIcon)
                                    ),
                                    React.createElement('button', { onClick: () => setModalHabit(habit), className: "p-3 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition" },
                                        React.createElement(PlusCircleIcon)
                                    ),
                                    React.createElement('button', { onClick: () => handleDeleteHabit(habit.id), className: "p-3 bg-gray-100 text-gray-500 rounded-full hover:bg-gray-200 transition" },
                                        React.createElement(TrashIcon)
                                    )
                                )
                            );
                        }) :
                        React.createElement('p', { className: "text-gray-500 text-center py-8" }, "No habits yet. Add one to get started!")
                    )
                ),

                // Right/Side Column: Recent Sessions
                React.createElement('div', { className: "lg:col-span-1" },
                    React.createElement('h2', { className: "text-2xl font-bold text-gray-800 mb-4" }, "Recent Sessions"),
                    React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm space-y-3 max-h-[600px] overflow-y-auto" },
                        sessions.length > 0 ? sessions.slice(0, 15).map(session => 
                            React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0" },
                                React.createElement('p', { className: "font-semibold" }, session.habitName),
                                React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                    React.createElement('span', null, formatDate(session.startTime)),
                                    React.createElement('span', null, formatTime(session.duration))
                                )
                            )
                        ) :
                        React.createElement('p', { className: "text-gray-500" }, "No sessions recorded yet.")
                    )
                )
            );
        };

        const Reports = ({ db, userId, setNotification }) => {
            const [reportData, setReportData] = useState([]);
            const [sessions, setSessions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;

                const fetchReportData = async () => {
                    setIsLoading(true);
                    try {
                        const [year, monthNum] = month.split('-').map(Number);
                        const startDate = new Date(year, monthNum - 1, 1);
                        const endDate = new Date(year, monthNum, 0, 23, 59, 59);

                        const sessionsQuery = window.query(
                            window.collection(db, `/artifacts/${appId}/users/${userId}/sessions`),
                            window.where('startTime', '>=', window.Timestamp.fromDate(startDate)),
                            window.where('startTime', '<=', window.Timestamp.fromDate(endDate))
                        );

                        const snapshot = await window.getDocs(sessionsQuery);
                        const monthlySessions = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                        monthlySessions.sort((a,b) => b.startTime.toMillis() - a.startTime.toMillis());
                        setSessions(monthlySessions);

                        const data = monthlySessions.reduce((acc, session) => {
                            acc[session.habitName] = (acc[session.habitName] || 0) + session.duration;
                            return acc;
                        }, {});
                        
                        const formattedData = Object.entries(data).map(([name, duration]) => ({ name, duration }));
                        setReportData(formattedData);

                    } catch (error) {
                        console.error("Error fetching report data:", error);
                        setNotification({ type: 'error', message: 'Failed to load report data.' });
                    } finally {
                        setIsLoading(false);
                    }
                };

                fetchReportData();
            }, [db, userId, month, appId, setNotification]);
            
            const maxDuration = Math.max(...reportData.map(d => d.duration), 0);
            const colors = ['bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500'];

            return React.createElement('div', { className: "max-w-7xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-4" }, "Monthly Report"),
                React.createElement('div', { className: "mb-6" },
                    React.createElement('label', { htmlFor: "month-select", className: "mr-2 font-semibold" }, "Select Month:"),
                    React.createElement('input', {
                        type: "month",
                        id: "month-select",
                        value: month,
                        onChange: e => setMonth(e.target.value),
                        className: "p-2 border border-gray-300 rounded-lg"
                    })
                ),

                isLoading ? 
                    React.createElement('div', { className: "flex justify-center items-center p-8" },
                        React.createElement(LoaderIcon),
                        React.createElement('span', { className: "ml-2" }, "Generating report...")
                    ) :
                    React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-8" },
                        // Chart Section
                        React.createElement('div', { className: "bg-white p-6 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl font-bold mb-4" }, "Habit Totals"),
                            React.createElement('div', { className: "space-y-4" },
                                reportData.length > 0 ? reportData.map((item, index) => 
                                    React.createElement('div', { key: item.name },
                                        React.createElement('div', { className: "flex justify-between mb-1 text-sm font-medium" },
                                            React.createElement('span', null, item.name),
                                            React.createElement('span', null, formatTime(item.duration))
                                        ),
                                        React.createElement('div', { className: "w-full bg-gray-200 rounded-full h-4" },
                                            React.createElement('div', {
                                                className: `${colors[index % colors.length]} h-4 rounded-full`,
                                                style: { width: `${maxDuration > 0 ? (item.duration / maxDuration) * 100 : 0}%` }
                                            })
                                        )
                                    )
                                ) : React.createElement('p', null, "No data for this month.")
                            )
                        ),

                        // Sessions List
                        React.createElement('div', { className: "bg-white p-4 rounded-lg shadow-sm" },
                            React.createElement('h3', { className: "text-xl font-bold mb-4" }, "Session Log"),
                            React.createElement('div', { className: "space-y-3 max-h-[400px] overflow-y-auto" },
                                sessions.length > 0 ? sessions.map(session => 
                                    React.createElement('div', { key: session.id, className: "border-b pb-2 last:border-b-0" },
                                        React.createElement('p', { className: "font-semibold" }, session.habitName),
                                        React.createElement('div', { className: "flex justify-between text-sm text-gray-600" },
                                            React.createElement('span', null, formatDate(session.startTime)),
                                            React.createElement('span', null, formatTime(session.duration))
                                        )
                                    )
                                ) :
                                React.createElement('p', { className: "text-gray-500" }, "No sessions recorded this month.")
                            )
                        )
                    )
            );
        };

        const Settings = ({ auth, userId }) => {
            const handleLogout = () => {
                window.signOut(auth);
            };

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl font-bold text-gray-800 mb-6" }, "Settings"),

                // Account Information Section
                React.createElement('div', { className: "bg-white rounded-lg shadow-sm p-6 mb-6" },
                    React.createElement('h3', { className: "text-xl font-semibold text-gray-700 mb-4" }, "Account Information"),
                    React.createElement('div', { className: "space-y-3" },
                        React.createElement('div', { className: "flex justify-between items-center py-2 border-b" },
                            React.createElement('span', { className: "text-gray-600" }, "User ID:"),
                            React.createElement('span', { className: "font-mono text-sm text-gray-800 truncate ml-4" }, userId)
                        ),
                        React.createElement('div', { className: "flex justify-between items-center py-2 border-b" },
                            React.createElement('span', { className: "text-gray-600" }, "Email:"),
                            React.createElement('span', { className: "text-gray-800" }, auth.currentUser?.email || 'Guest User')
                        ),
                        React.createElement('div', { className: "flex justify-between items-center py-2" },
                            React.createElement('span', { className: "text-gray-600" }, "Account Type:"),
                            React.createElement('span', { className: "text-gray-800" }, auth.currentUser?.isAnonymous ? 'Guest' : 'Registered')
                        )
                    )
                ),

                // Actions Section
                React.createElement('div', { className: "bg-white rounded-lg shadow-sm p-6" },
                    React.createElement('h3', { className: "text-xl font-semibold text-gray-700 mb-4" }, "Actions"),
                    React.createElement('button', {
                        onClick: handleLogout,
                        className: "w-full sm:w-auto bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700 transition flex items-center justify-center gap-2"
                    },
                        React.createElement(LogOutIcon),
                        "Sign Out"
                    )
                )
            );
        };

        // GoalSection component - moved outside Goals to prevent re-creation on each render
        const GoalSection = ({ type, title, color, placeholder, activeGoals, newGoalText, setNewGoalText, handleAddGoal, handleToggleGoal, handleDeleteGoal }) => {
            const sectionGoals = activeGoals.filter(g => g.type === type);

            return React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6" },
                React.createElement('h3', { className: "text-xl font-light mb-4", style: { color, fontWeight: 300 } }, title),

                // Goal input
                React.createElement('div', { className: "flex gap-2 mb-4" },
                    React.createElement('input', {
                        type: "text",
                        value: newGoalText[type],
                        onChange: (e) => setNewGoalText({ ...newGoalText, [type]: e.target.value }),
                        onKeyPress: (e) => e.key === 'Enter' && handleAddGoal(type),
                        placeholder,
                        className: "flex-grow px-4 py-2 border border-calm-300 rounded-xl focus:ring-2 focus:outline-none transition",
                        style: { borderColor: '#d1d7e3', fontWeight: 300 }
                    }),
                    React.createElement('button', {
                        onClick: () => handleAddGoal(type),
                        className: "px-4 py-2 rounded-xl soft-shadow hover:opacity-90 transition text-white",
                        style: { backgroundColor: color, fontWeight: 400 }
                    }, "+")
                ),

                // Goal list
                React.createElement('div', { className: "space-y-2" },
                    sectionGoals.map(goal =>
                        React.createElement('div', {
                            key: goal.id,
                            className: "flex items-center gap-3 p-2 rounded-lg hover:bg-calm-50 transition group"
                        },
                            React.createElement('input', {
                                type: "checkbox",
                                checked: false,
                                onChange: () => handleToggleGoal(goal),
                                className: "w-5 h-5 rounded border-calm-400 cursor-pointer"
                            }),
                            React.createElement('span', {
                                className: "flex-grow text-calm-800",
                                style: { fontWeight: 300 }
                            }, goal.text),
                            React.createElement('button', {
                                onClick: () => handleDeleteGoal(goal.id),
                                className: "opacity-0 group-hover:opacity-100 text-calm-400 hover:text-red-500 transition",
                                style: { fontSize: '0.9rem' }
                            }, "×")
                        )
                    )
                )
            );
        };

        const Goals = ({ db, userId, setNotification }) => {
            const [goals, setGoals] = useState([]);
            const [newGoalText, setNewGoalText] = useState({ daily: '', weekly: '', monthly: '', yearly: '' });
            const [isLoading, setIsLoading] = useState(true);

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            useEffect(() => {
                if (!db || !userId) return;

                const goalsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/goals`);

                const unsubscribe = window.onSnapshot(goalsCol, (snapshot) => {
                    const goalsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setGoals(goalsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching goals:", error);
                    setNotification({ type: 'error', message: "Could not fetch goals." });
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, appId, setNotification]);

            const handleAddGoal = async (type) => {
                const text = newGoalText[type].trim();
                if (!text) return;

                try {
                    const goalsCol = window.collection(db, `/artifacts/${appId}/users/${userId}/goals`);
                    await window.addDoc(goalsCol, {
                        text,
                        type,
                        completed: false,
                        createdAt: window.Timestamp.now()
                    });
                    setNewGoalText({ ...newGoalText, [type]: '' });
                    setNotification({ type: 'success', message: 'Goal added!' });
                } catch (error) {
                    console.error("Error adding goal:", error);
                    setNotification({ type: 'error', message: 'Failed to add goal.' });
                }
            };

            const handleToggleGoal = async (goal) => {
                try {
                    const goalDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/goals/${goal.id}`);
                    await window.setDoc(goalDocRef, {
                        ...goal,
                        completed: !goal.completed,
                        completedAt: !goal.completed ? window.Timestamp.now() : null
                    }, { merge: true });
                } catch (error) {
                    console.error("Error toggling goal:", error);
                    setNotification({ type: 'error', message: 'Failed to update goal.' });
                }
            };

            const handleDeleteGoal = async (goalId) => {
                try {
                    const goalDocRef = window.doc(db, `/artifacts/${appId}/users/${userId}/goals/${goalId}`);
                    await window.deleteDoc(goalDocRef);
                    setNotification({ type: 'success', message: 'Goal deleted!' });
                } catch (error) {
                    console.error("Error deleting goal:", error);
                    setNotification({ type: 'error', message: 'Failed to delete goal.' });
                }
            };

            const activeGoals = goals.filter(g => !g.completed);
            const completedGoals = goals.filter(g => g.completed).sort((a, b) =>
                (b.completedAt?.toMillis() || 0) - (a.completedAt?.toMillis() || 0)
            );

            if (isLoading) {
                return React.createElement('div', { className: "flex justify-center items-center p-8" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "ml-2" }, "Loading your goals...")
                );
            }

            return React.createElement('div', { className: "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8" },
                React.createElement('h2', { className: "text-3xl text-calm-800 mb-2", style: { fontWeight: 300 } }, "my goals"),
                React.createElement('p', { className: "text-calm-600 mb-6", style: { fontWeight: 300 } }, "set and track your goals"),

                React.createElement('div', { className: "space-y-6" },
                    React.createElement(GoalSection, {
                        type: 'daily',
                        title: 'daily goals',
                        color: '#5FA8A3',
                        placeholder: "what do you want to accomplish today?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'weekly',
                        title: 'weekly goals',
                        color: '#6B8DD6',
                        placeholder: "what do you want to accomplish this week?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'monthly',
                        title: 'monthly goals',
                        color: '#8B7FB8',
                        placeholder: "what do you want to accomplish this month?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),
                    React.createElement(GoalSection, {
                        type: 'yearly',
                        title: 'yearly goals',
                        color: '#7d8ca8',
                        placeholder: "what do you want to accomplish this year?",
                        activeGoals,
                        newGoalText,
                        setNewGoalText,
                        handleAddGoal,
                        handleToggleGoal,
                        handleDeleteGoal
                    }),

                    // Completed Goals Section
                    completedGoals.length > 0 && React.createElement('div', { className: "bg-white rounded-xl soft-shadow p-6 mt-8" },
                        React.createElement('h3', { className: "text-xl text-calm-600 mb-4", style: { fontWeight: 300 } }, "completed goals"),
                        React.createElement('div', { className: "space-y-2" },
                            completedGoals.map(goal =>
                                React.createElement('div', {
                                    key: goal.id,
                                    className: "flex items-center gap-3 p-2 rounded-lg hover:bg-calm-50 transition group"
                                },
                                    React.createElement('input', {
                                        type: "checkbox",
                                        checked: true,
                                        onChange: () => handleToggleGoal(goal),
                                        className: "w-5 h-5 rounded border-calm-400 cursor-pointer"
                                    }),
                                    React.createElement('span', {
                                        className: "flex-grow text-calm-500 line-through",
                                        style: { fontWeight: 300 }
                                    }, goal.text),
                                    React.createElement('span', {
                                        className: "text-xs text-calm-400",
                                        style: { fontWeight: 300 }
                                    }, goal.completedAt ? formatDate(goal.completedAt) : ''),
                                    React.createElement('button', {
                                        onClick: () => handleDeleteGoal(goal.id),
                                        className: "opacity-0 group-hover:opacity-100 text-calm-400 hover:text-red-500 transition",
                                        style: { fontSize: '0.9rem' }
                                    }, "×")
                                )
                            )
                        )
                    )
                )
            );
        };

        // --- Main App Component ---
        function App() {
            // These would be provided by the environment (e.g., Netlify build environment variables)
            // For local testing, you would replace these with your actual Firebase config.
            const firebaseConfig = typeof __firebase_config !== 'undefined' 
                ? __firebase_config 
                : { /* YOUR FIREBASE CONFIG HERE FOR LOCAL TESTING */ };
                
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const [firebaseApp, setFirebaseApp] = useState(null);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                    const app = window.initializeApp(firebaseConfig);
                    const authInstance = window.getAuth(app);
                    const dbInstance = window.getFirestore(app);
                    
                    setFirebaseApp(app);
                    setAuth(authInstance);
                    setDb(dbInstance);

                    const unsubscribe = window.onAuthStateChanged(authInstance, async (user) => {
                        if (user) {
                            setUser(user);
                            setUserId(user.uid);
                        } else {
                            // If no user and an initial token exists, try to sign in with it.
                            // This handles the case where the Canvas environment provides a token.
                            if(initialAuthToken) {
                                 try {
                                    await window.signInWithCustomToken(authInstance, initialAuthToken);
                                    // The onAuthStateChanged will re-trigger with the new user.
                                 } catch (error) {
                                     console.error("Custom token sign-in failed, trying anonymous:", error);
                                     await window.signInAnonymously(authInstance); // Fallback to anonymous
                                 }
                            } else {
                                // Otherwise, no user and no token, so clear state.
                                setUser(null);
                                setUserId(null);
                            }
                        }
                        setIsAuthReady(true);
                    });
                    return () => unsubscribe();
                } else {
                    console.error("Firebase config is not available.");
                    setIsAuthReady(true); // Allow UI to render with an error or login state
                }
            }, [JSON.stringify(firebaseConfig), initialAuthToken]); // Effect depends on config values
            
            // Notification timeout
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            if (!isAuthReady) {
                return React.createElement('div', { className: "min-h-screen bg-gray-50 flex justify-center items-center" },
                    React.createElement(LoaderIcon),
                    React.createElement('span', { className: "text-xl ml-4" }, "Connecting...")
                );
            }

            return React.createElement('div', { className: "min-h-screen font-sans", style: { backgroundColor: '#f8f9fb' } },
                notification && React.createElement('div', {
                    className: `fixed top-5 right-5 p-4 rounded-2xl soft-shadow-lg text-white z-50 ${notification.type === 'success' ? 'neuron-pulse' : ''}`,
                    style: {
                        backgroundColor: notification.type === 'success' ? '#6B8DD6' : '#a8b3c7',
                        fontWeight: 300
                    }
                }, notification.message),

                !user ?
                    React.createElement(AuthComponent, { auth, setNotification }) :
                    React.createElement(React.Fragment, null,
                        React.createElement(Header, { setCurrentPage, currentPage }),
                        React.createElement('main', null,
                            currentPage === 'dashboard' && React.createElement(Dashboard, { db, userId, setNotification }),
                            currentPage === 'goals' && React.createElement(Goals, { db, userId, setNotification }),
                            currentPage === 'reports' && React.createElement(Reports, { db, userId, setNotification }),
                            currentPage === 'settings' && React.createElement(Settings, { auth, userId })
                        )
                    )
            );
        }

        // Render the app (React 18 syntax)
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>